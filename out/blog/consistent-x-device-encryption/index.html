<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Getting consistent Encryption in Node / PHP / Browser and openSSL</title><meta name="copyright" content="Dominik Feger"/><link rel="canonical" href="https://dev.lwlx.xyz/"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta property="og:site_name" content="dev.lwlx.xyz"/><meta property="og:url" content="https://dev.lwlx.xyz/"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta name="twitter:site" content="@lwlx"/><meta name="twitter:creator" content="@lwlx"/><meta name="twitter:image" content="/crypto.jpg"/><meta property="og:image" content="/crypto.jpg"/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-925c129bbe0560f6b8dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9307f483d5f18bd6c60f.js" as="script"/><link rel="preload" href="/_next/static/chunks/2e673fc21468a4432efcf19d818365d58fdba786.3bde9eafcb41c6ac17bc.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.93469a02a48268d1aa12.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-866d03da9e7ddea37aef.js" as="script"/><link rel="preload" href="/_next/static/chunks/a58f3d40a2fe7d102a34d530ac258b1586e746d5.03d0df94a6f2b092a22b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bblog%5D-d32f79d8e54f62fabbea.js" as="script"/><style id="__jsx-654247902">.devii-markdown p,.devii-markdown li{line-height:1.7;color:#333;}.devii-markdown h1,.devii-markdown h2,.devii-markdown h3,.devii-markdown h4,.devii-markdown h5,.devii-markdown h6{margin:0px;padding:0px;}.devii-markdown h1>a,.devii-markdown h2>a,.devii-markdown h3>a,.devii-markdown h4>a,.devii-markdown h5>a,.devii-markdown h6>a{-webkit-text-decoration:underline;text-decoration:underline;color:#F07693;}.devii-markdown hr{margin:20px 0px;opacity:0.35;}.devii-markdown h1{padding-top:30px;padding-bottom:10px;margin-top:30px;margin-bottom:30px;}.devii-markdown h2{padding-top:25px;padding-bottom:10px;margin-top:25px;margin-bottom:25px;}.devii-markdown h3{padding-top:20px;padding-bottom:10px;margin-top:20px;margin-bottom:20px;}.devii-markdown h4{padding-top:15px;padding-bottom:10px;margin-top:15px;margin-bottom:15px;}.devii-markdown h5{padding-top:10px;padding-bottom:10px;margin-top:10px;margin-bottom:10px;}.devii-markdown h6{padding-top:5px;padding-bottom:10px;margin-top:5px;margin-bottom:5px;}.devii-markdown p{padding:10px 0px;margin:10px 0px;}.devii-markdown li{padding:10px 0px;}.devii-markdown img{width:100%;border-radius:8px;box-shadow:0px 4px 30px #00000040;}.devii-markdown code{background-color:#F0769320;padding:3px 3px;border-radius:2px;font-size:16px;}.devii-markdown pre{margin:20px 0px !important;}.devii-markdown ol pre,.devii-markdown ol p{margin:0px 0px !important;}.devii-markdown blockquote{margin:0px;padding-left:1em;border-left:4px solid #F07693;}a{-webkit-text-decoration:underline;text-decoration:underline;color:#F07693;}</style><style id="__jsx-2179548495">html,body,#__next{min-height:100%;padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}</style></head><body><div id="__next"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh" class="jsx-2179548495"><div style="top:0;width:100%;height:50px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;padding:30px;font-size:12pt"><a href="/" style="text-decoration:none"><p style="color:#F07693">dev.lwlx.xyz</p></a><div style="flex:1"></div><a href="https://github.com/Lawlez/dev.lwlx.xyz" style="text-decoration:none"><p style="padding:0px 1em;color:#F07693">GitHub</p></a><a href="https://github.com/InfoSecx0" style="text-decoration:none"><p style="padding:0px 1em;color:#F07693">Twitter</p></a></div><div style="display:flex;flex-direction:row;justify-content:center;width:100%;padding:0px 0px 100px 0px"><div style="width:100%;max-width:960px"><img style="width:100%;max-width:100%;margin:0px" src="/crypto.jpg"/><div style="padding:50px 3vw 50px 3vw"><h1 style="margin:10px 0px 10px 0px;padding:0;border:none">Getting consistent Encryption in Node / PHP / Browser and openSSL</h1><hr style="height:1px;color:#eee;opacity:0.2;margin:25px 0px"/><div style="margin:0px;padding:0px"><div style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start"><img src="/profile.jpg" style="width:70px;height:70px;border-radius:35px;margin:0px 10px 0px 0px"/><div><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt">lwlx</p><p style="opacity:0.6;margin:2px;padding:0;line-height:1.2;font-size:11pt">October 29th, 2020</p><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt"><a style="text-decoration:none;color:#3b9488" href="https://twitter.com/InfoSecx0">@InfoSecx0</a></p></div></div></div></div><div style="width:100%;padding:0px 3vw"><div style="width:100%" class="jsx-654247902 devii-markdown"><p>I recently was tasked to find a solution for encrypting data in different places and to be able to decrypt them all in a browser during runtime.</p><p>Surprisingly, it was much harder than expected since there was so little documentation around this online. What was available were a few code only examples, so I was forced to do R&amp;D and just try all implementations and compare the in- &amp; outputs</p><p>Given the lack of a decent out-of-the-box solution, I worry that many developers are settling for easy to use, insecure, solutions which place limits on the security and flexibility of your project. Security should be easy to use and accessible.</p><blockquote><p>Clone the repo here to get started with this setup: <a href="https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a">https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a</a></p></blockquote><p>Let&#x27;s quickly run through each implementation:</p><h3>Using Node JS Crypto module</h3><p>Node Provides a nice <code>crypto</code>  implementation. It&#x27;s documentation is rather sparse, but this is what i ended up with by using:</p><ul><li><code>crypto.randomBytes()</code></li><li><code>crypto.createCipheriv()</code></li><li><code>crypto.createDecipheriv()</code></li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#1177ab">const</span><span> crypto </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">require</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;crypto&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span>*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63">***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span></span><span class="token token" style="color:#1177ab">const</span><span> encryption </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span>data </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;TestString {} Héllöüä&#x27;</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> secretPhrase </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> salt </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">128</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">/</span><span> </span><span class="token token" style="color:#4499ee">8</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>    </span><span class="token token" style="color:#4e5c63">//here we generate the key and give it back as a string, we use 100k iterations</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>    </span><span class="token token" style="color:#4e5c63">//as suggested in best practices</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>    </span><span class="token token" style="color:#4e5c63">//We can use the key multiple times to encrypt multiple things(-30GB), we just cant use</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>    </span><span class="token token" style="color:#4e5c63">//the same initialization vector twice</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>    </span><span class="token token" style="color:#4e5c63">//the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> configKey </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">pbkdf2Sync</span><span class="token token" style="color:#999999">(</span><span>secretPhrase</span><span class="token token" style="color:#999999">,</span><span> salt</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">100000</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;sha256&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span><span>    </span><span class="token token" style="color:#4e5c63">//create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span>    </span><span class="token token" style="color:#4e5c63">//create ciphers for each encryption using the shared key and the unuique IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> projectConfigCipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createCipheriv</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;aes-256-cbc&#x27;</span><span class="token token" style="color:#999999">,</span><span> configKey</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>    </span><span class="token token" style="color:#4e5c63">//encripting the storage location using the prepared cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>configStorageCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>        </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;STORAGE&#x27;</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;utf8&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span><span>    </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> configStorageCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span><span>	</span><span class="token token control-flow" style="color:#1177ab">return</span><span> encrypted
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span><span></span><span class="token token" style="color:#999999">}</span></span></code></pre><h3>Using browserify-aes&#x27;s node crypto like implementation inside the Browser</h3><p>Inside the browser, we cannot use Nodes.js built-in modules. Using <code>browserify-aes</code> we can use a node-like crypto implementation, which uses the same syntax as the node implementation. In my use case, I only need to decipher in the browser, this means I don’t have to worry about a true random key generation or ciphering.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token module" style="color:#1177ab">import</span><span> </span><span class="token token imports">crypto</span><span> </span><span class="token token module" style="color:#1177ab">from</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;browserify-aes&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span>*        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63">***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token function-variable" style="color:#c7526d">decrypt</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token parameter">hash</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> hash </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> hash</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">data</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>    </span><span class="token token" style="color:#4e5c63">//get IV from input, make sure its no longer than 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> hash</span><span class="token token" style="color:#999999">.</span><span class="token token" style="color:#4499ee">IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>    </span><span class="token token" style="color:#4e5c63">//ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> decipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createDecipheriv</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>        </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;aes256&#x27;</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>        process</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">env</span><span class="token token" style="color:#999999">.</span><span class="token token" style="color:#4499ee">APP_CONFIG_KEY</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>       </span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>    </span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>    </span><span class="token token" style="color:#4e5c63">//der hash wird nun decrypted mittels dem zuvor erstellten cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span><span>    </span><span class="token token" style="color:#1177ab">const</span><span> decrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span>         </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span>hash</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>     </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>   </span><span class="token token control-flow" style="color:#1177ab">return</span><span> </span><span class="token token known-class-name class-name">JSON</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">parse</span><span class="token token" style="color:#999999">(</span><span>decrypted</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span><span></span><span class="token token" style="color:#999999">}</span></span></code></pre><h3>ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL</h3><p>In PHP 7 we make use of the <code>openssl_encrypt</code> implementation to encrypt an utf8 string and finally encode it with <code>base64_encode</code>.
For decryption we also make use of the official openssl implementation <code>openssl_decrypt</code>, before decrypting we need to decode using <code>base64_decode</code>.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span>*        ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span class="token token doc-comment" style="color:#4e5c63">***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#1177ab">class</span><span> </span><span class="token token class-name">AESEncryption</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span>	</span><span class="token token" style="color:#4e5c63">//key length should be 256 bits for aes 256 this means we use a string with 32 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>	</span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token double-quoted-string" style="color:#c9c0be;background:#000000">&quot;5f08e0ec585393a8e2ca8f0a1a0ae752&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>	 </span><span class="token token" style="color:#4e5c63">//iv length should be always be 128 bit / 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>	</span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$iv</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token double-quoted-string" style="color:#c9c0be;background:#000000">&quot;05d387e7f773035a&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>	 </span><span class="token token" style="color:#4e5c63">// The AES uses a block size of sixteen octets (128 bits)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>	</span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$Method</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;AES-256-CBC&#x27;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>	</span><span class="token token doc-comment" style="color:#4e5c63">/**
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span>	  * use the AES to encrypt plaintext data and return a base 64 string
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span>	 *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span>	 * $key
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span class="token token doc-comment" style="color:#4e5c63">	 */</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>	</span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#1177ab">function</span><span> </span><span class="token token" style="color:#c7526d">encrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$cleartext</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>		</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#1177ab">empty</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">?</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#999999">:</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>		</span><span class="token token" style="color:#ee9900">$encrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">openssl_encrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$cleartext</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$Method</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">OPENSSL_RAW_DATA</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$iv</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span><span>		</span><span class="token token" style="color:#1177ab">return</span><span> </span><span class="token token" style="color:#c7526d">base64_encode</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span><span>	</span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">33</span><span>	</span><span class="token token doc-comment" style="color:#4e5c63">/**
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">34</span>	  * use the AES to decrypt a base 64 string into plaintext
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">35</span>	 *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">36</span>	 * $key
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">37</span><span class="token token doc-comment" style="color:#4e5c63">	 */</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">38</span><span>	</span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#1177ab">function</span><span> </span><span class="token token" style="color:#c7526d">decrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">39</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">40</span><span>		</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#1177ab">empty</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">?</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#999999">:</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">41</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">42</span><span>		</span><span class="token token" style="color:#ee9900">$encrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">base64_decode</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">43</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">44</span><span>		</span><span class="token token" style="color:#ee9900">$decrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">openssl_decrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$Method</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">OPENSSL_RAW_DATA</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$iv</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">45</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">46</span><span>		</span><span class="token token" style="color:#1177ab">return</span><span> </span><span class="token token" style="color:#c7526d">trim</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$decrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">47</span><span>	</span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">48</span><span></span><span class="token token" style="color:#999999">}</span></span></code></pre><h3>Using openssl for use in CLI</h3><p>Inside of a Command Line Interface we use <code>openssl</code> do en- or decrypt data.</p><p>for node/browserify to be able to decrypt it we need to add the <code>-nosalt</code> option, which disables salting the data.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token" style="color:#4e5c63">#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span></span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#4e5c63">#encrypt with key &amp; IV but no salt</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#c7526d">cat</span><span> config.json </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -A -nosalt -base64
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span></span><span class="token token" style="color:#4e5c63">#decrypt with key IV and base64</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span></span><span class="token token class-name" style="color:#f07693">echo</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;encryptedString&quot;</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -d -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -base64 -A</span></span></code></pre><h2>final solution</h2><p>...</p></div></div></div></div><div style="flex:1" class="jsx-2179548495"></div><div style="top:0;width:100%;height:56px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;color:#F07693;padding:32px;font-size:12pt"><p>© Dominik (lwlx) Feger 2020</p><a href="/rss.xml"><img src="/rss-white.svg" alt="RSS Feed" height="24" width="24"/></a><p>Version <!-- -->0.1.0</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"path":"blog/consistent-x-device-encryption","title":"Getting consistent Encryption in Node / PHP / Browser and openSSL","subtitle":null,"published":true,"datePublished":1603967203286,"tags":["encryption","decryption","openssl","nodejs","php"],"description":null,"canonicalUrl":"https://dev.lwlx.xyz/","author":"lwlx","authorPhoto":"/profile.jpg","authorTwitter":"InfoSecx0","bannerPhoto":"/crypto.jpg","thumbnailPhoto":"/crypto_thumb.jpg","content":"\nI recently was tasked to find a solution for encrypting data in different places and to be able to decrypt them all in a browser during runtime.\n\nSurprisingly, it was much harder than expected since there was so little documentation around this online. What was available were a few code only examples, so I was forced to do R\u0026D and just try all implementations and compare the in- \u0026 outputs\n\nGiven the lack of a decent out-of-the-box solution, I worry that many developers are settling for easy to use, insecure, solutions which place limits on the security and flexibility of your project. Security should be easy to use and accessible.\n\n\u003e Clone the repo here to get started with this setup: \u003ca href=\"https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a\"\u003ehttps://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a\u003c/a\u003e\n\nLet's quickly run through each implementation:\n\n### Using Node JS Crypto module\n\nNode Provides a nice `crypto`  implementation. It's documentation is rather sparse, but this is what i ended up with by using:\n- `crypto.randomBytes()`\n- `crypto.createCipheriv()`\n- `crypto.createDecipheriv()`\n\n```javascript\nconst crypto = require('crypto')\n\n/**********************************************************************\n*\n*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *\n*\n***********************************************************************/\n\nconst encryption = (data = 'TestString {} Héllöüä') =\u003e {\n\n    const secretPhrase = crypto.randomBytes(16).toString('hex')\n    const salt = crypto.randomBytes(128 / 8).toString('hex')\n    //here we generate the key and give it back as a string, we use 100k iterations\n    //as suggested in best practices\n    //We can use the key multiple times to encrypt multiple things(-30GB), we just cant use\n    //the same initialization vector twice\n    //the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters\n    const configKey = crypto.pbkdf2Sync(secretPhrase, salt, 100000, 32, 'sha256').toString('hex').substr(0, 32)\n    //create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes\n    const IV = crypto.randomBytes(16)\n\n    //create ciphers for each encryption using the shared key and the unuique IV\n    const projectConfigCipher = crypto.createCipheriv('aes-256-cbc', configKey, IV.toString('hex').substr(0,16)\n\n    //encripting the storage location using the prepared cipher\n    const encrypted = Buffer.concat([configStorageCipher.update(\n        'STORAGE', 'utf8'\n    ), configStorageCipher.final()]).toString('hex')\n\n\treturn encrypted\n\n}\n```\n\n### Using browserify-aes's node crypto like implementation inside the Browser\n\nInside the browser, we cannot use Nodes.js built-in modules. Using `browserify-aes` we can use a node-like crypto implementation, which uses the same syntax as the node implementation. In my use case, I only need to decipher in the browser, this means I don’t have to worry about a true random key generation or ciphering.\n\n```js\nimport crypto from 'browserify-aes'\n\n/**********************************************************************\n*\n*        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *\n*\n***********************************************************************/\nconst decrypt = hash =\u003e {\n    const hash = hash.data\n    //get IV from input, make sure its no longer than 16 bytes\n    const IV = hash.IV\n\n    //ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV\n    const decipher = crypto.createDecipheriv(\n        'aes256',\n        process.env.APP_CONFIG_KEY.substr(0, 32),\n       IV,\n    )\n\n    //der hash wird nun decrypted mittels dem zuvor erstellten cipher\n    const decrypted = Buffer.concat([decipher.update(\n         Buffer.from(hash, 'hex'),\n     ), decipher.final()]).toString()\n\n   return JSON.parse(decrypted)\n}\n```\n\n### ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL\n\nIn PHP 7 we make use of the `openssl_encrypt` implementation to encrypt an utf8 string and finally encode it with `base64_encode`.\nFor decryption we also make use of the official openssl implementation `openssl_decrypt`, before decrypting we need to decode using `base64_decode`.\n\n```php\n/**********************************************************************\n*\n*        ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *\n*\n***********************************************************************/\n\nclass AESEncryption {\n\n\t//key length should be 256 bits for aes 256 this means we use a string with 32 bytes\n\tpublic static $key = \"5f08e0ec585393a8e2ca8f0a1a0ae752\";\n\n\t //iv length should be always be 128 bit / 16 bytes\n\tpublic static $iv = \"05d387e7f773035a\";\n\n\t // The AES uses a block size of sixteen octets (128 bits)\n\tpublic static $Method = 'AES-256-CBC';\n\n\t/**\n\t  * use the AES to encrypt plaintext data and return a base 64 string\n\t *\n\t * $key\n\t */\n\tpublic static function encrypt($cleartext,$key = ''){\n\n\t\t$key = empty($key) ? self::$key : $key;\n\n\t\t$encrypted = openssl_encrypt($cleartext, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n\t\treturn base64_encode($encrypted);\n\n\t}\n\n\t/**\n\t  * use the AES to decrypt a base 64 string into plaintext\n\t *\n\t * $key\n\t */\n\tpublic static function decrypt($encrypted,$key = ''){\n\n\t\t$key = empty($key) ? self::$key : $key;\n\n\t\t$encrypted = base64_decode($encrypted);\n\n\t\t$decrypted = openssl_decrypt($encrypted, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n\t\treturn trim($decrypted);\n\t}\n}\n```\n\n### Using openssl for use in CLI\n\nInside of a Command Line Interface we use `openssl` do en- or decrypt data.\n\nfor node/browserify to be able to decrypt it we need to add the `-nosalt` option, which disables salting the data.\n\n```bash\n#########################################################################################\n#                                                                                       #\n#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #\n#                                                                                       #\n#########################################################################################\n\n#encrypt with key \u0026 IV but no salt\ncat config.json | openssl aes-256-cbc -iv $(cat iv)  -K $(cat key) -A -nosalt -base64\n\n#decrypt with key IV and base64\necho \"encryptedString\" | openssl aes-256-cbc -d -iv $(cat iv)  -K $(cat key) -base64 -A\n```\n\n## final solution\n\n...\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"consistent-x-device-encryption"},"buildId":"G5QYsQSK0sNnzFBLavmWL","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["title",{"children":"Getting consistent Encryption in Node / PHP / Browser and openSSL"}],["meta",{"name":"copyright","content":"Dominik Feger"}],["link",{"rel":"canonical","href":"https://dev.lwlx.xyz/"}],["meta",{"property":"og:type","content":"website"}],["meta",{"name":"og:title","property":"og:title","content":"Getting consistent Encryption in Node / PHP / Browser and openSSL"}],["meta",{"property":"og:site_name","content":"dev.lwlx.xyz"}],["meta",{"property":"og:url","content":"https://dev.lwlx.xyz/"}],["meta",{"name":"twitter:card","content":"summary"}],["meta",{"name":"twitter:title","content":"Getting consistent Encryption in Node / PHP / Browser and openSSL"}],["meta",{"name":"twitter:site","content":"@lwlx"}],["meta",{"name":"twitter:creator","content":"@lwlx"}],["meta",{"name":"twitter:image","content":"/crypto.jpg"}],["meta",{"property":"og:image","content":"/crypto.jpg"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-925c129bbe0560f6b8dc.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.9307f483d5f18bd6c60f.js" async=""></script><script src="/_next/static/chunks/2e673fc21468a4432efcf19d818365d58fdba786.3bde9eafcb41c6ac17bc.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.93469a02a48268d1aa12.js" async=""></script><script src="/_next/static/chunks/pages/_app-866d03da9e7ddea37aef.js" async=""></script><script src="/_next/static/chunks/a58f3d40a2fe7d102a34d530ac258b1586e746d5.03d0df94a6f2b092a22b.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-d32f79d8e54f62fabbea.js" async=""></script><script src="/_next/static/G5QYsQSK0sNnzFBLavmWL/_buildManifest.js" async=""></script><script src="/_next/static/G5QYsQSK0sNnzFBLavmWL/_ssgManifest.js" async=""></script></body></html>