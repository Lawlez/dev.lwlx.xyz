<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Getting consistent Encryption in Node / PHP / Browser and openSSL</title><meta name="copyright" content="Colin McDonnell"/><link rel="canonical" href="https://dev.lwlx.xyz/"/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta property="og:site_name" content="dev.lwlx.xyz"/><meta property="og:url" content="https://dev.lwlx.xyz/"/><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta name="twitter:site" content="@lwlx"/><meta name="twitter:creator" content="@lwlx"/><meta name="twitter:image" content="/crypto.jpg"/><meta property="og:image" content="/crypto.jpg"/><meta name="next-head-count" content="15"/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-7574b5f2560487b662c2.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.4cb66147a9c8c0fd8872.js" as="script"/><link rel="preload" href="/_next/static/chunks/ac5da378b4ecd4a38d3f62a9e50ea23347a0e932.b1e9d5f6f84b74cfdc79.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.4f74c9488847d06a0cf9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-1961519019159f928e8c.js" as="script"/><link rel="preload" href="/_next/static/chunks/c1dbd67d6d9c688ae4d7fa2d396d98e2a73eef47.00b8410f5530a9bad6b6.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bblog%5D-a06e06ab2fd3f06709f2.js" as="script"/><style id="__jsx-516165434">.devii-markdown p,.devii-markdown li{line-height:1.7;color:#333;}.devii-markdown h1,.devii-markdown h2,.devii-markdown h3,.devii-markdown h4,.devii-markdown h5,.devii-markdown h6{margin:0px;padding:0px;}.devii-markdown h1>a,.devii-markdown h2>a,.devii-markdown h3>a,.devii-markdown h4>a,.devii-markdown h5>a,.devii-markdown h6>a{-webkit-text-decoration:none;text-decoration:none;}.devii-markdown hr{margin:20px 0px;opacity:0.35;}.devii-markdown h1{padding-top:30px;padding-bottom:10px;margin-top:30px;margin-bottom:30px;}.devii-markdown h2{padding-top:25px;padding-bottom:10px;margin-top:25px;margin-bottom:25px;}.devii-markdown h3{padding-top:20px;padding-bottom:10px;margin-top:20px;margin-bottom:20px;}.devii-markdown h4{padding-top:15px;padding-bottom:10px;margin-top:15px;margin-bottom:15px;}.devii-markdown h5{padding-top:10px;padding-bottom:10px;margin-top:10px;margin-bottom:10px;}.devii-markdown h6{padding-top:5px;padding-bottom:10px;margin-top:5px;margin-bottom:5px;}.devii-markdown p{padding:10px 0px;margin:10px 0px;}.devii-markdown li{padding:10px 0px;}.devii-markdown img{width:100%;border-radius:8px;box-shadow:0px 4px 30px #00000040;}.devii-markdown code{background-color:#00000010;padding:3px 3px;border-radius:2px;}.devii-markdown pre{margin:20px 0px !important;}.devii-markdown ol pre,.devii-markdown ol p{margin:0px 0px !important;}.devii-markdown blockquote{margin:0px;padding-left:1em;border-left:4px solid #4E5C63;}</style><style id="__jsx-2179548495">html,body,#__next{min-height:100%;padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}</style></head><body><div id="__next"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh" class="jsx-2179548495"><div style="top:0;width:100%;height:50px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#4E5C63;padding:30px;font-size:12pt"><a href="/" style="text-decoration:none"><p style="color:white">dev.lwlx.xyz</p></a><div style="flex:1"></div><a href="https://github.com/Lawlez/dev.lwlx.xyz" style="text-decoration:none"><p style="padding:0px 1em;color:white">GitHub</p></a><a href="/blog/the-ultimate-tech-stack" style="text-decoration:none"><p style="padding:0px 1em;color:white">Motivation</p></a></div><div style="display:flex;flex-direction:row;justify-content:center;width:100%;padding:0px 0px 100px 0px"><div style="width:100%;max-width:960px"><img style="width:100%;max-width:100%;margin:0px" src="/crypto.jpg"/><div style="padding:50px 3vw 50px 3vw"><h1 style="margin:10px 0px 10px 0px;padding:0;border:none">Getting consistent Encryption in Node / PHP / Browser and openSSL</h1><hr style="height:1px;color:#eee;opacity:0.2;margin:25px 0px"/><div style="margin:0px;padding:0px"><div style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start"><img src="/profile.jpg" style="width:70px;height:70px;border-radius:35px;margin:0px 10px 0px 0px"/><div><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt">lwlx</p><p style="opacity:0.6;margin:2px;padding:0;line-height:1.2;font-size:11pt">October 29th, 2020</p><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt"><a style="text-decoration:none;color:#3b9488" href="https://twitter.com/InfoSecx0">@InfoSecx0</a></p></div></div></div></div><div style="width:100%;padding:0px 3vw"><div style="width:100%" class="jsx-516165434 devii-markdown"><p>I recently set out to build my personal website — the one you&#x27;re reading now, as it happens!</p><p>Surprisingly, it was much harder than expected to put together a &quot;tech stack&quot; that met my criteria. My criteria are pretty straightforward; I would expect most React devs to have a similar list. Yet it was surprisingly hard to put all these pieces together.</p><p>Given the lack of a decent out-of-the-box solution, I worry that many developers are settling for static-site generators that place limits on the interactivity and flexibility of your website. We can do better.</p><blockquote><p>Clone the repo here to get started with this setup: <a href="https://github.com/Lawlez/dev.lwlx.xyz">https://github.com/Lawlez/dev.lwlx.xyz</a></p></blockquote><p>Let&#x27;s quickly run through my list of design goals:</p><h3>Using Node JS Crypto module</h3><p>I want to build the site with React and TypeScript. I love them both wholeheartedly, I use them for my day job, and they&#x27;re gonna be around for a long time. Plus writing untyped JS makes me feel dirty.</p><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#cc7832">const</span> crypto <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#ffc66d">require</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;crypto&#x27;</span><span class="token" style="color:#a9b7c6">)</span>
<span class="token doc-comment" style="color:#808080">
/**********************************************************************
*
*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *
*
***********************************************************************/</span>

<span class="token" style="color:#cc7832">const</span> encryption <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#a9b7c6">(</span>data <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#6a8759">&#x27;TestString {} Héllöüä&#x27;</span><span class="token" style="color:#a9b7c6">)</span> <span class="token arrow" style="color:#a9b7c6">=&gt;</span> <span class="token" style="color:#a9b7c6">{</span>

    <span class="token" style="color:#cc7832">const</span> secretPhrase <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">randomBytes</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">16</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span>
    <span class="token" style="color:#cc7832">const</span> salt <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">randomBytes</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">128</span> <span class="token" style="color:#a9b7c6">/</span> <span class="token" style="color:#6897bb">8</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span>
    <span class="token" style="color:#808080">//here we generate the key and give it back as a string, we use 100k iterations</span>
    <span class="token" style="color:#808080">//as suggested in best practices</span>
    <span class="token" style="color:#808080">//We can use the key multiple times to encrypt multiple things(-30GB), we just cant use</span>
    <span class="token" style="color:#808080">//the same initialization vector twice</span>
    <span class="token" style="color:#808080">//the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters</span>
    <span class="token" style="color:#cc7832">const</span> configKey <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">pbkdf2Sync</span><span class="token" style="color:#a9b7c6">(</span>secretPhrase<span class="token" style="color:#a9b7c6">,</span> salt<span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6897bb">100000</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6897bb">32</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6a8759">&#x27;sha256&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">substr</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6897bb">32</span><span class="token" style="color:#a9b7c6">)</span>
    <span class="token" style="color:#808080">//create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes</span>
    <span class="token" style="color:#cc7832">const</span> <span class="token" style="color:#9876aa">IV</span> <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">randomBytes</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">16</span><span class="token" style="color:#a9b7c6">)</span>

    <span class="token" style="color:#808080">//create ciphers for each encryption using the shared key and the unuique IV</span>
    <span class="token" style="color:#cc7832">const</span> projectConfigCipher <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">createCipheriv</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;aes-256-cbc&#x27;</span><span class="token" style="color:#a9b7c6">,</span> configKey<span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#9876aa">IV</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">substr</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span><span class="token" style="color:#6897bb">16</span><span class="token" style="color:#a9b7c6">)</span>

    <span class="token" style="color:#808080">//encripting the storage location using the prepared cipher</span>
    <span class="token" style="color:#cc7832">const</span> encrypted <span class="token" style="color:#a9b7c6">=</span> <span class="token maybe-class-name">Buffer</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">concat</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">[</span>configStorageCipher<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">update</span><span class="token" style="color:#a9b7c6">(</span>
        <span class="token" style="color:#6a8759">&#x27;STORAGE&#x27;</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6a8759">&#x27;utf8&#x27;</span>
    <span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span> configStorageCipher<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">final</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span>

	<span class="token" style="color:#cc7832">return</span> encrypted

<span class="token" style="color:#a9b7c6">}</span></code></pre><h3>Using browserify-aes&#x27;s node crypto like implementation inside the Browser</h3><p>If it&#x27;s obnoxious to write new blog posts, I won&#x27;t do it. That&#x27;s a regrettable law of the universe. Even writing blog posts with plain HTML — just a bunch of <code>&lt;p&gt;</code> tags in a div — is just annoying enough to bug me. The answer: Markdown of course!</p><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#cc7832">import</span> crypto <span class="token module" style="color:#cc7832">from</span> <span class="token" style="color:#6a8759">&#x27;browserify-aes&#x27;</span>
<span class="token doc-comment" style="color:#808080">
/**********************************************************************
*
*        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *
*
***********************************************************************/</span>
<span class="token" style="color:#cc7832">const</span> <span class="token function-variable" style="color:#ffc66d">decrypt</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token parameter">hash</span> <span class="token arrow" style="color:#a9b7c6">=&gt;</span> <span class="token" style="color:#a9b7c6">{</span>
    <span class="token" style="color:#cc7832">const</span> hash <span class="token" style="color:#a9b7c6">=</span> hash<span class="token" style="color:#a9b7c6">.</span><span class="token property-access">data</span>
    <span class="token" style="color:#808080">//get IV from input, make sure its no longer than 16 bytes</span>
    <span class="token" style="color:#cc7832">const</span> <span class="token" style="color:#9876aa">IV</span> <span class="token" style="color:#a9b7c6">=</span> hash<span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#9876aa">IV</span>

    <span class="token" style="color:#808080">//ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV</span>
    <span class="token" style="color:#cc7832">const</span> decipher <span class="token" style="color:#a9b7c6">=</span> crypto<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">createDecipheriv</span><span class="token" style="color:#a9b7c6">(</span>
        <span class="token" style="color:#6a8759">&#x27;aes256&#x27;</span><span class="token" style="color:#a9b7c6">,</span>
        process<span class="token" style="color:#a9b7c6">.</span><span class="token property-access">env</span><span class="token" style="color:#a9b7c6">.</span><span class="token" style="color:#9876aa">APP_CONFIG_KEY</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">substr</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#6897bb">0</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6897bb">32</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span>
       <span class="token" style="color:#9876aa">IV</span><span class="token" style="color:#a9b7c6">,</span>
    <span class="token" style="color:#a9b7c6">)</span>

    <span class="token" style="color:#808080">//der hash wird nun decrypted mittels dem zuvor erstellten cipher</span>
    <span class="token" style="color:#cc7832">const</span> decrypted <span class="token" style="color:#a9b7c6">=</span> <span class="token maybe-class-name">Buffer</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">concat</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">[</span>decipher<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">update</span><span class="token" style="color:#a9b7c6">(</span>
         <span class="token maybe-class-name">Buffer</span><span class="token" style="color:#a9b7c6">.</span><span class="token module" style="color:#cc7832">from</span><span class="token" style="color:#a9b7c6">(</span>hash<span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#6a8759">&#x27;hex&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span>
     <span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">,</span> decipher<span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">final</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">]</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">toString</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#a9b7c6">)</span>

   <span class="token" style="color:#cc7832">return</span> <span class="token known-class-name class-name">JSON</span><span class="token" style="color:#a9b7c6">.</span><span class="token method property-access" style="color:#ffc66d">parse</span><span class="token" style="color:#a9b7c6">(</span>decrypted<span class="token" style="color:#a9b7c6">)</span>
<span class="token" style="color:#a9b7c6">}</span></code></pre><h3>ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL</h3><p>As much as I love the Jamstack, it doesn&#x27;t cut it from an SEO perspective. Many blogs powered by a &quot;headless CMS&quot; require two round trips before rendering the blog content (one to fetch the static JS bundle and another to fetch the blog content from a CMS). This degrades page load speeds and user experience, which accordingly degrades your rankings on Google.</p><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token doc-comment" style="color:#808080">/**********************************************************************
*
*        ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *
*
***********************************************************************/</span>

<span class="token" style="color:#cc7832">class</span> <span class="token class-name">AESEncryption</span> <span class="token" style="color:#a9b7c6">{</span>

	<span class="token" style="color:#808080">//key length should be 256 bits for aes 256 this means we use a string with 32 bytes</span>
	<span class="token" style="color:#cc7832">public</span> <span class="token" style="color:#cc7832">static</span> <span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token double-quoted-string" style="color:#6a8759">&quot;5f08e0ec585393a8e2ca8f0a1a0ae752&quot;</span><span class="token" style="color:#a9b7c6">;</span>

	 <span class="token" style="color:#808080">//iv length should be always be 128 bit / 16 bytes</span>
	<span class="token" style="color:#cc7832">public</span> <span class="token" style="color:#cc7832">static</span> <span class="token" style="color:#9876aa">$iv</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token double-quoted-string" style="color:#6a8759">&quot;05d387e7f773035a&quot;</span><span class="token" style="color:#a9b7c6">;</span>

	 <span class="token" style="color:#808080">// The AES uses a block size of sixteen octets (128 bits)</span>
	<span class="token" style="color:#cc7832">public</span> <span class="token" style="color:#cc7832">static</span> <span class="token" style="color:#9876aa">$Method</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token single-quoted-string" style="color:#6a8759">&#x27;AES-256-CBC&#x27;</span><span class="token" style="color:#a9b7c6">;</span>

<span class="token doc-comment" style="color:#808080">	/**
	  * use the AES to encrypt plaintext data and return a base 64 string
	 *
	 * $key
	 */</span>
	<span class="token" style="color:#cc7832">public</span> <span class="token" style="color:#cc7832">static</span> <span class="token" style="color:#cc7832">function</span> <span class="token" style="color:#ffc66d">encrypt</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$cleartext</span><span class="token" style="color:#a9b7c6">,</span><span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token single-quoted-string" style="color:#6a8759">&#x27;&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">{</span>

		<span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#cc7832">empty</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">)</span> <span class="token" style="color:#a9b7c6">?</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">:</span> <span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">;</span>

		<span class="token" style="color:#9876aa">$encrypted</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#ffc66d">openssl_encrypt</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$cleartext</span><span class="token" style="color:#a9b7c6">,</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$Method</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#9876aa">OPENSSL_RAW_DATA</span><span class="token" style="color:#a9b7c6">,</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$iv</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span>

		<span class="token" style="color:#cc7832">return</span> <span class="token" style="color:#ffc66d">base64_encode</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$encrypted</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span>

	<span class="token" style="color:#a9b7c6">}</span>

<span class="token doc-comment" style="color:#808080">	/**
	  * use the AES to decrypt a base 64 string into plaintext
	 *
	 * $key
	 */</span>
	<span class="token" style="color:#cc7832">public</span> <span class="token" style="color:#cc7832">static</span> <span class="token" style="color:#cc7832">function</span> <span class="token" style="color:#ffc66d">decrypt</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$encrypted</span><span class="token" style="color:#a9b7c6">,</span><span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token single-quoted-string" style="color:#6a8759">&#x27;&#x27;</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">{</span>

		<span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#cc7832">empty</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">)</span> <span class="token" style="color:#a9b7c6">?</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$key</span> <span class="token" style="color:#a9b7c6">:</span> <span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">;</span>

		<span class="token" style="color:#9876aa">$encrypted</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#ffc66d">base64_decode</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$encrypted</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span>

		<span class="token" style="color:#9876aa">$decrypted</span> <span class="token" style="color:#a9b7c6">=</span> <span class="token" style="color:#ffc66d">openssl_decrypt</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$encrypted</span><span class="token" style="color:#a9b7c6">,</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$Method</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#9876aa">$key</span><span class="token" style="color:#a9b7c6">,</span> <span class="token" style="color:#9876aa">OPENSSL_RAW_DATA</span><span class="token" style="color:#a9b7c6">,</span> <span class="token scope"><span class="token" style="color:#cc7832">self</span><span class="token" style="color:#a9b7c6">::</span></span><span class="token" style="color:#9876aa">$iv</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span>

		<span class="token" style="color:#cc7832">return</span> <span class="token" style="color:#ffc66d">trim</span><span class="token" style="color:#a9b7c6">(</span><span class="token" style="color:#9876aa">$decrypted</span><span class="token" style="color:#a9b7c6">)</span><span class="token" style="color:#a9b7c6">;</span>
	<span class="token" style="color:#a9b7c6">}</span>
<span class="token" style="color:#a9b7c6">}</span></code></pre><h3>Using openssl for use in CLI</h3><p>I describe my final architecture design below, along with my rationale for each choice. I distilled this setup into a website starter/boilerplate available here: <a href="https://github.com/Lawlez/dev.lwlx.xyz">https://github.com/Lawlez/dev.lwlx.xyz</a>. Below, I allude to certain files/functions I implemented; to see the source code of these, just clone the repo <code>git clone git@github.com:vriad/devii.git</code></p><pre style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#808080">#########################################################################################</span>
<span class="token" style="color:#808080">#                                                                                       #</span>
<span class="token" style="color:#808080">#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #</span>
<span class="token" style="color:#808080">#                                                                                       #</span>
<span class="token" style="color:#808080">#########################################################################################</span>

<span class="token" style="color:#808080">#encrypt with key &amp; IV but no salt</span>
<span class="token" style="color:#ffc66d">cat</span> config.json <span class="token" style="color:#a9b7c6">|</span> openssl aes-256-cbc -iv <span class="token" style="color:#9876aa"><span class="token" style="color:#9876aa">$(</span><span class="token" style="color:#ffc66d">cat</span> iv<span class="token" style="color:#9876aa">)</span></span>  -K <span class="token" style="color:#9876aa"><span class="token" style="color:#9876aa">$(</span><span class="token" style="color:#ffc66d">cat</span> key<span class="token" style="color:#9876aa">)</span></span> -A -nosalt -base64

<span class="token" style="color:#808080">#decrypt with key IV and base64</span>
<span class="token class-name" style="color:#e8bf6a">echo</span> <span class="token" style="color:#6a8759">&quot;encryptedString&quot;</span> <span class="token" style="color:#a9b7c6">|</span> openssl aes-256-cbc -d -iv <span class="token" style="color:#9876aa"><span class="token" style="color:#9876aa">$(</span><span class="token" style="color:#ffc66d">cat</span> iv<span class="token" style="color:#9876aa">)</span></span>  -K <span class="token" style="color:#9876aa"><span class="token" style="color:#9876aa">$(</span><span class="token" style="color:#ffc66d">cat</span> key<span class="token" style="color:#9876aa">)</span></span> -base64 -A</code></pre><h2>final solution</h2><p>...</p></div></div></div></div><div style="flex:1" class="jsx-2179548495"></div><div style="top:0;width:100%;height:50px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#4E5C63;color:white;padding:30px;font-size:12pt"><p>© Dominik (lwlx) Feger 2020</p><a href="/rss.xml"><img src="/rss-white.svg" alt="RSS Feed" height="30" width="30"/></a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"path":"blog/consistent-x-device-encryption","title":"Getting consistent Encryption in Node / PHP / Browser and openSSL","subtitle":null,"published":true,"datePublished":1603967203286,"tags":["encryption","decryption","openssl","nodejs","php"],"description":null,"canonicalUrl":"https://dev.lwlx.xyz/","author":"lwlx","authorPhoto":"/profile.jpg","authorTwitter":"InfoSecx0","bannerPhoto":"/crypto.jpg","thumbnailPhoto":"/crypto_thumb.jpg","content":"\nI recently set out to build my personal website — the one you're reading now, as it happens!\n\nSurprisingly, it was much harder than expected to put together a \"tech stack\" that met my criteria. My criteria are pretty straightforward; I would expect most React devs to have a similar list. Yet it was surprisingly hard to put all these pieces together.\n\nGiven the lack of a decent out-of-the-box solution, I worry that many developers are settling for static-site generators that place limits on the interactivity and flexibility of your website. We can do better.\n\n\u003e Clone the repo here to get started with this setup: https://github.com/Lawlez/dev.lwlx.xyz\n\nLet's quickly run through my list of design goals:\n\n### Using Node JS Crypto module\n\nI want to build the site with React and TypeScript. I love them both wholeheartedly, I use them for my day job, and they're gonna be around for a long time. Plus writing untyped JS makes me feel dirty.\n\n```javascript\nconst crypto = require('crypto')\n\n/**********************************************************************\n*\n*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *\n*\n***********************************************************************/\n\nconst encryption = (data = 'TestString {} Héllöüä') =\u003e {\n\n    const secretPhrase = crypto.randomBytes(16).toString('hex')\n    const salt = crypto.randomBytes(128 / 8).toString('hex')\n    //here we generate the key and give it back as a string, we use 100k iterations\n    //as suggested in best practices\n    //We can use the key multiple times to encrypt multiple things(-30GB), we just cant use\n    //the same initialization vector twice\n    //the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters\n    const configKey = crypto.pbkdf2Sync(secretPhrase, salt, 100000, 32, 'sha256').toString('hex').substr(0, 32)\n    //create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes\n    const IV = crypto.randomBytes(16)\n\n    //create ciphers for each encryption using the shared key and the unuique IV\n    const projectConfigCipher = crypto.createCipheriv('aes-256-cbc', configKey, IV.toString('hex').substr(0,16)\n\n    //encripting the storage location using the prepared cipher\n    const encrypted = Buffer.concat([configStorageCipher.update(\n        'STORAGE', 'utf8'\n    ), configStorageCipher.final()]).toString('hex')\n\n\treturn encrypted\n\n}\n```\n\n### Using browserify-aes's node crypto like implementation inside the Browser\n\nIf it's obnoxious to write new blog posts, I won't do it. That's a regrettable law of the universe. Even writing blog posts with plain HTML — just a bunch of `\u003cp\u003e` tags in a div — is just annoying enough to bug me. The answer: Markdown of course!\n\n```javascript\nimport crypto from 'browserify-aes'\n\n/**********************************************************************\n*\n*        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *\n*\n***********************************************************************/\nconst decrypt = hash =\u003e {\n    const hash = hash.data\n    //get IV from input, make sure its no longer than 16 bytes\n    const IV = hash.IV\n\n    //ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV\n    const decipher = crypto.createDecipheriv(\n        'aes256',\n        process.env.APP_CONFIG_KEY.substr(0, 32),\n       IV,\n    )\n\n    //der hash wird nun decrypted mittels dem zuvor erstellten cipher\n    const decrypted = Buffer.concat([decipher.update(\n         Buffer.from(hash, 'hex'),\n     ), decipher.final()]).toString()\n\n   return JSON.parse(decrypted)\n}\n```\n\n### ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL\n\nAs much as I love the Jamstack, it doesn't cut it from an SEO perspective. Many blogs powered by a \"headless CMS\" require two round trips before rendering the blog content (one to fetch the static JS bundle and another to fetch the blog content from a CMS). This degrades page load speeds and user experience, which accordingly degrades your rankings on Google.\n\n```php\n/**********************************************************************\n*\n*        ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *\n*\n***********************************************************************/\n\nclass AESEncryption {\n\n\t//key length should be 256 bits for aes 256 this means we use a string with 32 bytes\n\tpublic static $key = \"5f08e0ec585393a8e2ca8f0a1a0ae752\";\n\n\t //iv length should be always be 128 bit / 16 bytes\n\tpublic static $iv = \"05d387e7f773035a\";\n\n\t // The AES uses a block size of sixteen octets (128 bits)\n\tpublic static $Method = 'AES-256-CBC';\n\n\t/**\n\t  * use the AES to encrypt plaintext data and return a base 64 string\n\t *\n\t * $key\n\t */\n\tpublic static function encrypt($cleartext,$key = ''){\n\n\t\t$key = empty($key) ? self::$key : $key;\n\n\t\t$encrypted = openssl_encrypt($cleartext, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n\t\treturn base64_encode($encrypted);\n\n\t}\n\n\t/**\n\t  * use the AES to decrypt a base 64 string into plaintext\n\t *\n\t * $key\n\t */\n\tpublic static function decrypt($encrypted,$key = ''){\n\n\t\t$key = empty($key) ? self::$key : $key;\n\n\t\t$encrypted = base64_decode($encrypted);\n\n\t\t$decrypted = openssl_decrypt($encrypted, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n\t\treturn trim($decrypted);\n\t}\n}\n```\n\n### Using openssl for use in CLI\n\nI describe my final architecture design below, along with my rationale for each choice. I distilled this setup into a website starter/boilerplate available here: https://github.com/Lawlez/dev.lwlx.xyz. Below, I allude to certain files/functions I implemented; to see the source code of these, just clone the repo `git clone git@github.com:vriad/devii.git`\n\n```bash\n#########################################################################################\n#                                                                                       #\n#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #\n#                                                                                       #\n#########################################################################################\n\n#encrypt with key \u0026 IV but no salt\ncat config.json | openssl aes-256-cbc -iv $(cat iv)  -K $(cat key) -A -nosalt -base64\n\n#decrypt with key IV and base64\necho \"encryptedString\" | openssl aes-256-cbc -d -iv $(cat iv)  -K $(cat key) -base64 -A\n```\n\n## final solution\n\n...\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"consistent-x-device-encryption"},"buildId":"qKwg0YnrW08k4omS7_J3Y","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-7574b5f2560487b662c2.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.4cb66147a9c8c0fd8872.js" async=""></script><script src="/_next/static/chunks/ac5da378b4ecd4a38d3f62a9e50ea23347a0e932.b1e9d5f6f84b74cfdc79.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.4f74c9488847d06a0cf9.js" async=""></script><script src="/_next/static/chunks/pages/_app-1961519019159f928e8c.js" async=""></script><script src="/_next/static/chunks/c1dbd67d6d9c688ae4d7fa2d396d98e2a73eef47.00b8410f5530a9bad6b6.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-a06e06ab2fd3f06709f2.js" async=""></script><script src="/_next/static/qKwg0YnrW08k4omS7_J3Y/_buildManifest.js" async=""></script><script src="/_next/static/qKwg0YnrW08k4omS7_J3Y/_ssgManifest.js" async=""></script></body></html>