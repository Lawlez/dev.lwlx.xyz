<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="preconnect" href="https://fonts.gstatic.com" class="jsx-2351541611"/><link href="https://fonts.googleapis.com/css2?family=Fira+Code&amp;display=swap" rel="stylesheet" class="jsx-2351541611"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TZ2VB384DV" class="jsx-2351541611"></script><script class="jsx-2351541611">
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());

            gtag('config', 'G-TZ2VB384DV');
            </script><title>MitM using WPAD Proxy Protocol:Getting a reverse shell on windows client</title><meta name="copyright" content="lwlx. 2021"/><link rel="canonical" href="https://dev.lwlx.xyz/blog/abuse-WPAD-protocol-to-MitM-any-network"/><meta name="description" content="When a decision made 25+ years ago makes your computer vulnerable to the stupidest attack you&#x27;ve heard of."/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="MitM using WPAD Proxy Protocol:Getting a reverse shell on windows client"/><meta name="og:description" property="og:description" content="When a decision made 25+ years ago makes your computer vulnerable to the stupidest attack you&#x27;ve heard of."/><meta property="og:site_name" content="dev.lwlx.xyz"/><meta property="og:url" content="https://dev.lwlx.xyz/blog/abuse-WPAD-protocol-to-MitM-any-network"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="MitM using WPAD Proxy Protocol:Getting a reverse shell on windows client"/><meta name="twitter:description" content="When a decision made 25+ years ago makes your computer vulnerable to the stupidest attack you&#x27;ve heard of."/><meta name="twitter:site" content="@0x0000005"/><meta name="twitter:creator" content="@0x0000005"/><meta name="twitter:image" content="https://dev.lwlx.xyz/wpad-responder-exploit/wpad_post_img"/><meta property="og:image" content="https://dev.lwlx.xyz/wpad-responder-exploit/wpad_post_img"/><meta name="next-head-count" content="22"/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-cb9553d22ab415bfeeda.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.e517df81bfe1ace171f1.js" as="script"/><link rel="preload" href="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.fae379f0df79f611694c.js" as="script"/><link rel="preload" href="/_next/static/chunks/dd48059e07d9e613287d2b9ed68ceff9c6eda536.125197913eb8fc4f758d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-a2c8f0cefe211cf87beb.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bblog%5D-39d210f309b0b0245842.js" as="script"/><style id="__jsx-2285729993">.blog-post{width:100%;max-width:1080px;}</style><style id="__jsx-659067766">.lwlx-markdown p,.lwlx-markdown li{line-height:32px;font-size:21px;color:#333;overflow-wrap:break-word;}.lwlx-markdown h1,.lwlx-markdown h2,.lwlx-markdown h3,.lwlx-markdown h4,.lwlx-markdown h5,.lwlx-markdown h6{margin:0px;padding:0px;}.lwlx-markdown h1>a,.lwlx-markdown h2>a,.lwlx-markdown h3>a,.lwlx-markdown h4>a,.lwlx-markdown h5>a,.lwlx-markdown h6>a{-webkit-text-decoration:underline;text-decoration:underline;color:#f07693;}.lwlx-markdown hr{margin:20px 0px;opacity:0.35;}.lwlx-markdown h1{font-size:1.5em;line-height:56px;padding-top:30px;padding-bottom:10px;margin-top:30px;margin-bottom:30px;}.lwlx-markdown h2{font-size:1.3em;padding-top:25px;padding-bottom:10px;margin-top:25px;margin-bottom:25px;}.lwlx-markdown h3{font-size:1.2em;padding-top:20px;padding-bottom:10px;margin-top:20px;margin-bottom:20px;}.lwlx-markdown h4{font-size:1em;padding-top:15px;padding-bottom:10px;margin-top:15px;margin-bottom:15px;}.lwlx-markdown h5{padding-top:10px;padding-bottom:10px;margin-top:10px;margin-bottom:10px;}.lwlx-markdown h6{padding-top:5px;padding-bottom:10px;margin-top:5px;margin-bottom:5px;}.lwlx-markdown p{padding:10px 0px;margin:10px 0px;}.lwlx-markdown li{padding:10px 0px;}.lwlx-markdown img{width:100%;border-radius:8px;box-shadow:0px 4px 30px #00000040;}.lwlx-markdown code{font-family:"Fira Code",monospace;background-color:#f0769320;padding:2px 2px;border-radius:2px;font-size:13px;}.lwlx-markdown pre{margin:12px 0px !important;}.lwlx-markdown ol pre,.lwlx-markdown ol p{margin:0px 0px !important;}.lwlx-markdown blockquote{margin:0px;padding-left:1em;border-left:4px solid #F07693;}.lwlx-markdown table{padding:4px;background:rgba(0,0,0,0.02);}.lwlx-markdown table code{background-color:#f0769320;padding:2px 2px;border-radius:4px;font-size:1em;line-height:1.8em;}.lwlx-markdown tbody td{padding:12px;border-top:solid 1px #00000020;}.lwlx-markdown thead td{padding:8px;background:#f07693;font-size:16px;}a{-webkit-text-decoration:underline;text-decoration:underline;color:#f07693;}@media only screen and (min-width:768px){.lwlx-markdown code{background-color:#f0769320;padding:3px 3px;border-radius:2px;font-size:16px;}.lwlx-markdown h1{font-size:46px;line-height:56px;padding-top:30px;padding-bottom:10px;margin-top:30px;margin-bottom:30px;}.lwlx-markdown h2{padding-top:25px;padding-bottom:10px;margin-top:25px;margin-bottom:25px;}.lwlx-markdown h3{padding-top:20px;padding-bottom:10px;margin-top:20px;margin-bottom:20px;}.lwlx-markdown h4{padding-top:15px;padding-bottom:10px;margin-top:15px;margin-bottom:15px;}.lwlx-markdown h5{padding-top:10px;padding-bottom:10px;margin-top:10px;margin-bottom:10px;}.lwlx-markdown h6{padding-top:5px;padding-bottom:10px;margin-top:5px;margin-bottom:5px;}.lwlx-markdown p{padding:10px 0px;margin:10px 0px;}}</style><style id="__jsx-2351541611">html,body,#__next{min-height:100%;padding:0;margin:0;background:#e6e6e6;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}pre{border-radius:8px;box-shadow:0px 4px 12px #00000060;}*{box-sizing:border-box;}</style></head><body><div id="__next"><div style="display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh" class="jsx-2351541611"><div style="top:0;width:100%;height:48px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;padding:24px;font-size:12pt;font-family:Fira Code"><a href="/" style="text-decoration:none"><p style="color:#F07693">dev.lwlx.xyz</p></a><div style="flex:1"></div><a href="https://github.com/Lawlez/myOSWE" style="text-decoration:none;display:flex;align-items:center"><svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true" style="margin-right:-12px"><path fill="#F07693" fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg><p style="padding:0px 1em;color:#F07693">GitHub</p></a><a href="https://twitter.com/0x0000005" style="text-decoration:none;display:flex;align-items:center"><svg height="16" viewBox="0 0 24 24" style="margin-right:-12px"><g><path fill="#F07693" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g></svg><p style="padding:0px 1em;color:#F07693">Twitter</p></a></div><div style="display:flex;flex-direction:row;justify-content:center;width:100%;padding:0px 0px 100px 0px" class="jsx-2285729993"><div class="jsx-2285729993 blog-post"><picture><source srcSet="/wpad-responder-exploit/wpad_post_img.webp" type="image/webp" style="width:100%;max-width:100%;margin:0px;max-height:490px"/><img src="/wpad-responder-exploit/wpad_post_img.jpg" style="width:100%;max-width:100%;margin:0px;max-height:490px"/></picture><div style="padding:32px 2vw 8px 2vw" class="jsx-2285729993"><h1 style="margin:8px 0px 8px 0px;padding:0;border:none;font-size:2.6em;font-family:Fira Code" class="jsx-2285729993">MitM using WPAD Proxy Protocol:</h1><h2 style="margin:8px 0px;padding:0;border:none;font-weight:400;opacity:0.6;font-family:Fira Code" class="jsx-2285729993">Getting a reverse shell on windows client</h2><hr style="height:2px;background:#1177AB;margin:24px 0px;border:none;border-radius:1px" class="jsx-2285729993"/><div style="font-family:Fira Code;margin:0px;padding:0px"><div style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start"><picture><source srcSet="/profile.webp" type="image/webp" style="width:64px;height:64px;border-radius:34px;margin:0px 8px 0px 0px"/><img src="/profile.jpg" style="width:64px;height:64px;border-radius:34px;margin:0px 8px 0px 0px"/></picture><div><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt">lwlx</p><p style="opacity:0.6;margin:2px;padding:0;line-height:1.2;font-size:11pt">19. November 2020</p><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt"><a style="text-decoration:none;color:#1177AB" href="https://twitter.com/0x0000005">@0x0000005</a></p></div></div></div></div><div style="width:100%;padding:0px 2vw" class="jsx-2285729993"><div style="width:100%" class="jsx-659067766 lwlx-markdown"><h2>What is WPAD? <code>[WIP]</code></h2><p>Sometime in the early days of the Internet - the web 1.0 era - a couple of devs at Netscape decided that JavaScript was an acceptable language to write configuration files in. The result was Proxy Auto-Config (PAC) - a configuration file format that works as follows: The browser connects to a pre-configured server, downloads the PAC file, and executes a particular Javascript function to determine proper proxy configuration. Why not? It is more expressive and less tedious than XML and seems reasonable to provide configurations to many clients.</p><p>PAC itself works with a protocol called Web Proxy Auto-Discovery (WPAD) WPAD removes the need for the browser or the user to have a pre-configured server to connect to. Instead, WPAD allows the computer to query the local network to discover the server to load the PAC file from.</p><h2>WPAD always follows this schema:</h2><ol><li>Determine if the system should use WPAD, either by looking at browser settings or asking the host OS if the browser is set to match the OS setting.</li><li>Ensure a network connection is available.</li><li>If WPAD is to be used, issue a DHCPINFORM query to ask for the URL of the PAC script.</li><li>If the DHCPINFORM query fails and does not return a URL, perform a DNS lookup for the hostname <code>wpad</code>.</li><li>If the DNS lookup succeeds, then the PAC URL is <code>http://wpad/wpad.dat</code>.</li><li>Establish an HTTP(S) connection to the discovered URL&#x27;s server, thus downloading the PAC script.</li><li>If the PAC script has downloaded successfully, parse it, and optionally compile it.</li><li>For each network request, call the <code>FindProxyForURL()</code> function in the PAC script and use the proxy settings returned from this function.</li></ol><blockquote><p>WPAD is practically asking the network &quot;Hey there! would you like to send me a <strong>payload</strong> i can <strong>execute</strong>?&quot;</p></blockquote><p>You can clearly see how a bad actor can abuse this.</p><p>Windows is certainly not the only piece of software that implements WPAD. Other operating systems (OS X, Linux) and applications do as well. For example, Google Chrome also has a WPAD implementation, but in Chrome&#x27;s case, the JavaScript code from the PAC is evaluated inside of a sandbox. Other operating systems that support WPAD don&#x27;t enable it by default anymore. That is why Windows is currently the most attractive target for this sort of attack.</p><h2>Exploit basis</h2><p>When a device has these protocols enabled, if the local network DNS cannot resolve the name, the machine will ask the whole network to get a host. So, any host of the network, who knows its IP, can reply. Even if a host replies with incorrect information, it will still be regarded as a legitimate response.</p><h1>Exploitable scenario</h1><ol><li>victim and host are in the same network</li><li>The victim opens the browser, which is configured with the option <code>automatically detect settings</code> in <code>Local Area Network (LAN) Settings</code>.</li><li>The name resolution, which is performed with the steps we mentioned earlier, will be questioned on the victim&#x27;s computer first.</li><li>In step 3, because the DNS Server does not have a corresponding record, the system&#x27;s name is sent as LLMNR or NetBIOS-NS query.</li><li>The attacker listens to network traffic, catches name resolution query. It tells to the victim that he has the wpad.dat the victim is look for.</li></ol><p>According to the flow above, if an attacker wants to make sure that the attack will be successful, he must perform the following attacks:</p><ul><li>DHCP poisoning attack</li><li>DNS poisoning attack</li><li>WPAD poisoning attack</li></ul><h2>start analyzing first</h2><p>using the <code>-A</code> option enables analyze only mode
<strong>macOS:</strong></p><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span>./Responder.py -i </span><span class="token token" style="color:#c9c0be;background:#000000">&lt;</span><span>your </span><span class="token token" style="color:#c7526d">ip</span><span> address</span><span class="token token" style="color:#c9c0be;background:#000000">&gt;</span><span> -A</span></span></code></pre><p><strong>Linux:</strong></p><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span>./Responder.py -I </span><span class="token token" style="color:#c9c0be;background:#000000">&lt;</span><span>your net interface</span><span class="token token" style="color:#c9c0be;background:#000000">&gt;</span><span> -A</span></span></code></pre><h2>create payload adn custom FindProxyForURL()</h2><h2>run the attack:</h2><ul><li><code>-w</code>: starts WPAD service</li><li><code>-f</code>: fingerprints victims</li><li><code>-v</code>: verbose output</li><li><code>-F</code>: force auth to WPAD service</li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span> ./Responder.py -i </span><span class="token token" style="color:#4499ee">192.168</span><span>.1.215 -w -f -v -F</span></span></code></pre><p>force basic auth to try and gain user &amp; pass</p><ul><li><code>-b</code>: force Basic HTTP authentication</li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;background:#04060a"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span> ./Responder.py -i </span><span class="token token" style="color:#4499ee">192.168</span><span>.1.215 -w -f -v -b -F</span></span></code></pre><p><img src="/wpad-responder-exploit/responder-intercepted.png" alt="Succsessfull WPAD attack" title="Succsessfull WPAD attack, planting a reverse shell on the victim."/></p><h1>Mitigation</h1><ul><li>Create a DNS entry called &quot;WPAD&quot; that points to the real proxy server.</li><li>Disabling automatic proxy discovery in browsers and operating systems.</li><li>Configure firewalls and proxies to block and log outbound requests for wpad.dat files.</li></ul><blockquote><h2><code>[WIP]</code> This article is a work in progress and will be updated with a proof of concept soon.</h2></blockquote></div></div></div></div><div style="flex:1" class="jsx-2351541611"></div><div style="top:0;width:100%;height:56px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;color:#F07693;padding:24px;font-size:12pt"><p>Â© lwlx. 2021</p><a href="https://twitter.com/0x0000005"><svg height="24" viewBox="0 0 24 24"><g><path fill="#fff" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g></svg></a><a href="https://github.com/Lawlez"><svg height="24" viewBox="0 0 16 16" version="1.1" width="24" aria-hidden="true"><path fill="#fff" fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a><p>Version <!-- -->0.5.3</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"path":"blog/abuse-WPAD-protocol-to-MitM-any-network","title":"MitM using WPAD Proxy Protocol:","subtitle":"Getting a reverse shell on windows client","published":true,"datePublished":1605802028864,"tags":["MitM","WPAD","aPAColypse","PAC","exploit","security"],"description":"When a decision made 25+ years ago makes your computer vulnerable to the stupidest attack you've heard of.","canonicalUrl":"https://dev.lwlx.xyz/blog/abuse-WPAD-protocol-to-MitM-any-network","author":"lwlx","authorPhoto":"/profile","authorTwitter":"0x0000005","bannerPhoto":"/wpad-responder-exploit/wpad_post_img","thumbnailPhoto":"/wpad-responder-exploit/wpad_thumb.jpg","content":"\n## What is WPAD? `[WIP]`\n\nSometime in the early days of the Internet - the web 1.0 era - a couple of devs at Netscape decided that JavaScript was an acceptable language to write configuration files in. The result was Proxy Auto-Config (PAC) - a configuration file format that works as follows: The browser connects to a pre-configured server, downloads the PAC file, and executes a particular Javascript function to determine proper proxy configuration. Why not? It is more expressive and less tedious than XML and seems reasonable to provide configurations to many clients.\n\nPAC itself works with a protocol called Web Proxy Auto-Discovery (WPAD) WPAD removes the need for the browser or the user to have a pre-configured server to connect to. Instead, WPAD allows the computer to query the local network to discover the server to load the PAC file from.\n\n## WPAD always follows this schema:\n\n1. Determine if the system should use WPAD, either by looking at browser settings or asking the host OS if the browser is set to match the OS setting.\n2. Ensure a network connection is available.\n3. If WPAD is to be used, issue a DHCPINFORM query to ask for the URL of the PAC script.\n4. If the DHCPINFORM query fails and does not return a URL, perform a DNS lookup for the hostname `wpad`.\n5. If the DNS lookup succeeds, then the PAC URL is `http://wpad/wpad.dat`.\n6. Establish an HTTP(S) connection to the discovered URL's server, thus downloading the PAC script.\n7. If the PAC script has downloaded successfully, parse it, and optionally compile it.\n8. For each network request, call the `FindProxyForURL()` function in the PAC script and use the proxy settings returned from this function.\n\n\u003e WPAD is practically asking the network \"Hey there! would you like to send me a **payload** i can **execute**?\"\n\nYou can clearly see how a bad actor can abuse this.\n\nWindows is certainly not the only piece of software that implements WPAD. Other operating systems (OS X, Linux) and applications do as well. For example, Google Chrome also has a WPAD implementation, but in Chrome's case, the JavaScript code from the PAC is evaluated inside of a sandbox. Other operating systems that support WPAD don't enable it by default anymore. That is why Windows is currently the most attractive target for this sort of attack.\n\n## Exploit basis\n\nWhen a device has these protocols enabled, if the local network DNS cannot resolve the name, the machine will ask the whole network to get a host. So, any host of the network, who knows its IP, can reply. Even if a host replies with incorrect information, it will still be regarded as a legitimate response.\n\n# Exploitable scenario\n\n1. victim and host are in the same network\n2. The victim opens the browser, which is configured with the option `automatically detect settings` in `Local Area Network (LAN) Settings`.\n3. The name resolution, which is performed with the steps we mentioned earlier, will be questioned on the victim's computer first.\n4. In step 3, because the DNS Server does not have a corresponding record, the system's name is sent as LLMNR or NetBIOS-NS query.\n5. The attacker listens to network traffic, catches name resolution query. It tells to the victim that he has the wpad.dat the victim is look for.\n\nAccording to the flow above, if an attacker wants to make sure that the attack will be successful, he must perform the following attacks:\n\n- DHCP poisoning attack\n- DNS poisoning attack\n- WPAD poisoning attack\n\n\u003c!--\n# proof of concept\n\n## install Responder\n\n## configure config\n--\u003e\n\n## start analyzing first\n\nusing the `-A` option enables analyze only mode\n**macOS:**\n\n```shell\n./Responder.py -i \u003cyour ip address\u003e -A\n```\n\n**Linux:**\n\n```shell\n./Responder.py -I \u003cyour net interface\u003e -A\n```\n\n## create payload adn custom FindProxyForURL()\n\n## run the attack:\n\n- `-w`: starts WPAD service\n- `-f`: fingerprints victims\n- `-v`: verbose output\n- `-F`: force auth to WPAD service\n\n```shell\n ./Responder.py -i 192.168.1.215 -w -f -v -F\n```\n\nforce basic auth to try and gain user \u0026 pass\n\n- `-b`: force Basic HTTP authentication\n\n```shell\n ./Responder.py -i 192.168.1.215 -w -f -v -b -F\n```\n\n![Succsessfull WPAD attack](/wpad-responder-exploit/responder-intercepted.png \"Succsessfull WPAD attack, planting a reverse shell on the victim.\")\n\n# Mitigation\n\n- Create a DNS entry called \"WPAD\" that points to the real proxy server.\n- Disabling automatic proxy discovery in browsers and operating systems.\n- Configure firewalls and proxies to block and log outbound requests for wpad.dat files.\n\n\u003e ## `[WIP]` This article is a work in progress and will be updated with a proof of concept soon.\n\n\u003c!--\n## Read more about this topic:\n\n[https://googleprojectzero.blogspot.com/2017/12/apacolypse-now-exploiting-windows-10-in_18.html](https://googleprojectzero.blogspot.com/2017/12/apacolypse-now-exploiting-windows-10-in_18.html)\n--\u003e\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"abuse-WPAD-protocol-to-MitM-any-network"},"buildId":"ycxQFtuk-rSgI1w_W9GhR","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8f31809deb7932dd0187.js"></script><script src="/_next/static/chunks/main-cb9553d22ab415bfeeda.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.e517df81bfe1ace171f1.js" async=""></script><script src="/_next/static/chunks/f6078781a05fe1bcb0902d23dbbb2662c8d200b3.fae379f0df79f611694c.js" async=""></script><script src="/_next/static/chunks/dd48059e07d9e613287d2b9ed68ceff9c6eda536.125197913eb8fc4f758d.js" async=""></script><script src="/_next/static/chunks/pages/_app-a2c8f0cefe211cf87beb.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-39d210f309b0b0245842.js" async=""></script><script src="/_next/static/ycxQFtuk-rSgI1w_W9GhR/_buildManifest.js" async=""></script><script src="/_next/static/ycxQFtuk-rSgI1w_W9GhR/_ssgManifest.js" async=""></script></body></html>