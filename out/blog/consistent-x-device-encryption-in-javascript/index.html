<!DOCTYPE html><html><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="preconnect" href="https://fonts.gstatic.com" class="jsx-37717e9a7cbc0337"/><link href="https://fonts.gstatic.com/s/firacode/v10/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJVD7MOzlojwUKQ.woff" rel="preload" crossorigin="crossorigin" type="font/woff2" as="font" class="jsx-37717e9a7cbc0337"/><link rel="stylesheet" class="jsx-37717e9a7cbc0337" data-href="https://fonts.googleapis.com/css2?family=Fira+Code&amp;display=swap" data-optimized-fonts="true"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TZ2VB384DV" class="jsx-37717e9a7cbc0337"></script><script class="jsx-37717e9a7cbc0337">
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());

            gtag('config', 'G-TZ2VB384DV');
            </script><title>Getting consistent Encryption in Node / PHP / Browser and openSSL</title><meta name="copyright" content="lwlx. 2021"/><link rel="canonical" href="https://dev.lwlx.xyz/blog/consistent-x-device-encryption-in-javascript"/><meta name="description" content="Cryptography is hard, and because it&#x27;s already hard enough, here is a nice guide on the AES Cipher in different environments."/><meta property="og:type" content="website"/><meta name="og:title" property="og:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta name="og:description" property="og:description" content="Cryptography is hard, and because it&#x27;s already hard enough, here is a nice guide on the AES Cipher in different environments."/><meta property="og:site_name" content="dev.lwlx.xyz"/><meta property="og:url" content="https://dev.lwlx.xyz/blog/consistent-x-device-encryption-in-javascript"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Getting consistent Encryption in Node / PHP / Browser and openSSL"/><meta name="twitter:description" content="Cryptography is hard, and because it&#x27;s already hard enough, here is a nice guide on the AES Cipher in different environments."/><meta name="twitter:site" content="@0x0000005"/><meta name="twitter:creator" content="@0x0000005"/><meta name="twitter:image" content="https://dev.lwlx.xyz/crypto"/><meta property="og:image" content="https://dev.lwlx.xyz/crypto"/><meta name="next-head-count" content="24"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-8465dd2bbe975cad.js" defer=""></script><script src="/_next/static/chunks/framework-4975f770e34de116.js" defer=""></script><script src="/_next/static/chunks/main-22bd8129361cadd1.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c2c75d2aaacb4235.js" defer=""></script><script src="/_next/static/chunks/286-52bf752def536adc.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-c79b0e7dc20f4dd8.js" defer=""></script><script src="/_next/static/sei3j9AmjPPP3iDNhxl-y/_buildManifest.js" defer=""></script><script src="/_next/static/sei3j9AmjPPP3iDNhxl-y/_ssgManifest.js" defer=""></script><script src="/_next/static/sei3j9AmjPPP3iDNhxl-y/_middlewareManifest.js" defer=""></script><style id="__jsx-62f0b32f662fb62a">.blog-post{width:100%;
max-width:1080px}</style><style id="__jsx-4132219113">.lwlx-markdown p, .lwlx-markdown li{line-height:32px;
font-size:16px;
color:#ccc;
overflow-wrap:break-word}
.lwlx-markdown h1, .lwlx-markdown h2, .lwlx-markdown h3, .lwlx-markdown h4, .lwlx-markdown h5, .lwlx-markdown h6{margin:0px;
padding:0px}
.lwlx-markdown h1>a, .lwlx-markdown h2>a, .lwlx-markdown h3>a, .lwlx-markdown h4>a, .lwlx-markdown h5>a, .lwlx-markdown h6>a{text-decoration:underline;
color:#f07693}
.lwlx-markdown hr{margin:20px 0px;
opacity:0.35}
.lwlx-markdown h1{font-size:1.5em;
line-height:56px;
padding-top:30px;
padding-bottom:10px;
margin-top:30px;
margin-bottom:30px}
.lwlx-markdown h2{font-size:1.3em;
padding-top:25px;
padding-bottom:10px;
margin-top:25px;
margin-bottom:25px}
.lwlx-markdown h3{font-size:1.2em;
padding-top:20px;
padding-bottom:10px;
margin-top:20px;
margin-bottom:20px}
.lwlx-markdown h4{font-size:1em;
padding-top:15px;
padding-bottom:10px;
margin-top:15px;
margin-bottom:15px}
.lwlx-markdown h5{padding-top:10px;
padding-bottom:10px;
margin-top:10px;
margin-bottom:10px}
.lwlx-markdown h6{padding-top:5px;
padding-bottom:10px;
margin-top:5px;
margin-bottom:5px}
.lwlx-markdown p{padding:10px 0px;
margin:10px 0px}
.lwlx-markdown li{padding:10px 0px}
.lwlx-markdown img{width:100%;
border-radius:8px;
box-shadow:0px 4px 30px #00000040}
.lwlx-markdown code{font-family:'Fira Code', monospace;
background-color:#f07693f0;
color:#222;
padding:2px 2px;
border-radius:2px;
font-size:13px}
.lwlx-markdown pre{margin:12px 0px!important}
.lwlx-markdown ol pre, .lwlx-markdown ol p{margin:0px 0px!important}
.lwlx-markdown blockquote{margin:0px;
padding-left:1em;
border-left:4px solid #F07693}
.lwlx-markdown table{padding:4px;
background:rgba(0, 0, 0, 0.02)}
.lwlx-markdown table code{background-color:#f07693f0;
color:#222;
padding:2px 2px;
border-radius:4px;
font-size:1em;
line-height:1.8em}
.lwlx-markdown tbody td{padding:12px;
border-top:solid 1px #00000020}
.lwlx-markdown thead td{padding:8px;
background:#f07693;
font-size:16px}
a{text-decoration:underline;
color:#f07693}
@media only screen and (min-width:768px) {.lwlx-markdown code{background-color:#f07693f0;
color:#222;
padding:3px 3px;
border-radius:2px;
font-size:16px}
.lwlx-markdown h1{font-size:46px;
line-height:56px;
padding-top:30px;
padding-bottom:10px;
margin-top:30px;
margin-bottom:30px}
.lwlx-markdown h2{padding-top:25px;
padding-bottom:10px;
margin-top:25px;
margin-bottom:25px}
.lwlx-markdown h3{padding-top:20px;
padding-bottom:10px;
margin-top:20px;
margin-bottom:20px}
.lwlx-markdown h4{padding-top:15px;
padding-bottom:10px;
margin-top:15px;
margin-bottom:15px}
.lwlx-markdown h5{padding-top:10px;
padding-bottom:10px;
margin-top:10px;
margin-bottom:10px}
.lwlx-markdown h6{padding-top:5px;
padding-bottom:10px;
margin-top:5px;
margin-bottom:5px}
.lwlx-markdown p{padding:10px 0px;
margin:10px 0px}}</style><style id="__jsx-37717e9a7cbc0337">html, body, #__next{min-height:100%;
font-family:Fira Code, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif}
*{box-sizing:border-box}</style><style data-href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap">@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sFVQ.woff) format('woff')}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJV37MOzlojwUKaJO.woff) format('woff');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJVT7MOzlojwUKaJO.woff) format('woff');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJVz7MOzlojwUKaJO.woff) format('woff');unicode-range:U+1F00-1FFF}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJVP7MOzlojwUKaJO.woff) format('woff');unicode-range:U+0370-03FF}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJV77MOzlojwUKaJO.woff) format('woff');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Fira Code';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/firacode/v14/uU9eCBsR6Z2vfE9aq3bL0fxyUs4tcw4W_D1sJVD7MOzlojwUKQ.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><style data-emotion="css-global 1bd2rq4">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:#fff;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#121212;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#121212;}</style><style data-emotion="css 1ourwbl">.css-1ourwbl{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;min-height:100vh;}</style><div class="MuiBox-root css-1ourwbl"><div style="top:0;width:90%;border-radius:12px;margin-top:14px;margin-bottom:12px;height:48px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;padding:24px;font-size:12pt;font-family:Fira Code;background:#141414;box-shadow:9px 9px 12px rgb(4,4,4,0.6), -9px -9px 11px  rgba(48,48,48, 0.5)"><a href="/" style="text-decoration:none"><p style="color:#F07693">dev.lwlx.xyz</p></a><div style="flex:1"></div><a href="https://github.com/Lawlez/myOSWE" style="text-decoration:none;display:flex;align-items:center"><svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true" style="margin-right:-12px"><path fill="#F07693" fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg><p style="padding:0px 1em;color:#F07693">GitHub</p></a><a href="https://twitter.com/0x0000005" style="text-decoration:none;display:flex;align-items:center"><svg height="16" viewBox="0 0 24 24" style="margin-right:-12px"><g><path fill="#F07693" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g></svg><p style="padding:0px 1em;color:#F07693">Twitter</p></a></div><style data-emotion="css 5csqms">.css-5csqms{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;}@media (min-width:1200px){.css-5csqms{max-width:1200px;}}</style><div class="MuiContainer-root MuiContainer-maxWidthLg MuiContainer-disableGutters css-5csqms"><div style="display:flex;flex-direction:row;justify-content:center;width:100%;padding:0px 0px 100px 0px" class="jsx-62f0b32f662fb62a"><div class="jsx-62f0b32f662fb62a blog-post"><picture><source srcSet="/crypto.webp" type="image/webp" style="width:100%;max-width:100%;margin:0px;max-height:490px"/><img src="/crypto.jpg" style="width:100%;max-width:100%;margin:0px;max-height:490px"/></picture><div style="padding:32px 2vw 8px 2vw" class="jsx-62f0b32f662fb62a"><h1 style="margin:8px 0px 8px 0px;padding:0;border:none;font-size:2.6em;font-family:Fira Code" class="jsx-62f0b32f662fb62a">Getting consistent Encryption in Node / PHP / Browser and openSSL</h1><hr style="height:2px;background:#1177AB;margin:24px 0px;border:none;border-radius:1px" class="jsx-62f0b32f662fb62a"/><div style="font-family:Fira Code;margin:0px;padding:0px"><div style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start"><picture><source srcSet="/profile.webp" type="image/webp" style="background:#141414;box-shadow:6px 6px 8px rgb(4,4,4,0.6), -6px -6px 8px  rgba(48,48,48, 0.5);width:64px;height:64px;border-radius:34px;margin:0px 8px 0px 0px"/><img src="/profile.jpg" style="background:#141414;box-shadow:6px 6px 8px rgb(4,4,4,0.6), -6px -6px 8px  rgba(48,48,48, 0.5);width:64px;height:64px;border-radius:34px;margin:0px 8px 0px 0px"/></picture><div><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt">lwlx</p><p style="opacity:0.6;margin:2px;padding:0;line-height:1.2;font-size:11pt">29. October 2020</p><p style="margin:2px;padding:0;line-height:1.2;font-size:11pt"><a style="text-decoration:none;color:#1177AB" href="https://twitter.com/0x0000005">@0x0000005</a></p></div></div></div></div><div style="width:100%;padding:0px 2vw" class="jsx-62f0b32f662fb62a"><div style="width:100%" class="jsx-4132219113 lwlx-markdown"><p>I recently was tasked to find a solution for encrypting data in different places and to being able to decrypt them all in a browser during runtime.</p><p>Surprisingly, it was much more challenging than expected since there was so little documentation around this online. What was available were a few code-only examples, so I was forced to do R &amp; D and try all implementations and compare the in- &amp; outputs.</p><p>Given the lack of a decent out-of-the-box solution, I worry that many developers are settling for easy to use, insecure solutions that limit your project’s security and flexibility. Security should be easy to use and accessible.</p><blockquote><p>Clone the repo here to get started with this setup: <a href="https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a">https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a</a></p></blockquote><p>Okay, so lets assume we use following input data to test each implementation:</p><ul><li><strong><code>key</code></strong> = &#x27;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&#x27; <code> //must be 256 bits</code></li><li><strong><code>iv</code></strong> = &#x27;1d6ef201e0e7a9019ddf8414034325e2&#x27; <code> //must be 128 bits</code></li><li><strong><code>inputData</code></strong> = <code>{&quot;TestData&quot;:&quot;w17h Spé^cIäl chàær§¢tèrs&quot;, &quot;OK&quot;:&quot;://seems/fine?x=lol&quot;}</code></li></ul><p>Let&#x27;s quickly run through and test each implementation:</p><h2>Using Node JS Crypto module</h2><p>Node Provides a nice <code>crypto</code> implementation. It&#x27;s documentation is rather sparse, but this is what most resources suggest by using:</p><ul><li><code>crypto.randomBytes()</code></li><li><code>crypto.createCipheriv()</code></li><li><code>crypto.createDecipheriv()</code></li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#1177ab">const</span><span> crypto </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">require</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;crypto&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span>*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63">***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span></span><span class="token token" style="color:#1177ab">const</span><span> encryption </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span>data </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;TestString {} Héllöüä&#x27;</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> secretPhrase </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> salt </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">128</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">/</span><span> </span><span class="token token" style="color:#4499ee">8</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>   </span><span class="token token" style="color:#4e5c63">//here we generate the key and give it back as a string, we use 100k iterations</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>   </span><span class="token token" style="color:#4e5c63">//as suggested in best practices</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>   </span><span class="token token" style="color:#4e5c63">//We can use the key multiple times to encrypt multiple things(-30GB), we just cant use</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>   </span><span class="token token" style="color:#4e5c63">//the same initialization vector twice</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>   </span><span class="token token" style="color:#4e5c63">//the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> configKey </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">pbkdf2Sync</span><span class="token token" style="color:#999999">(</span><span>secretPhrase</span><span class="token token" style="color:#999999">,</span><span> salt</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">100000</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;sha256&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span><span>   </span><span class="token token" style="color:#4e5c63">//create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span>   </span><span class="token token" style="color:#4e5c63">//create ciphers for each encryption using the shared key and the unuique IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> projectConfigCipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createCipheriv</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;aes-256-cbc&#x27;</span><span class="token token" style="color:#999999">,</span><span> configKey</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>   </span><span class="token token" style="color:#4e5c63">//encripting the storage location using the prepared cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span><span>   </span><span class="token token" style="color:#1177ab">const</span><span> encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>configStorageCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>       </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;STORAGE&#x27;</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;utf8&#x27;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span><span>   </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> configStorageCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span><span>   </span><span class="token token control-flow" style="color:#1177ab">return</span><span> encrypted
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span><span></span><span class="token token" style="color:#999999">}</span></span></code></pre><blockquote><p>this is <strong>NOT</strong> the final implementation; check below to see it.</p></blockquote><h3>Testing the implementation</h3><p>We notice that we need to trim the key to 32bytes and the IV to 16 bytes. This is likely because of the conversion from hex to string after the creation of the key.</p><ul><li><strong><code>key</code></strong> = &#x27;5035ae3567f2e69320b083d59a7364cf&#x27; <code> //is now 32 bytes string</code></li><li><strong><code>iv</code></strong> = &#x27;1d6ef201e0e7a901&#x27; <code> //is now 16 bytes string</code></li></ul><p>This will probably lead to an issue later on since other implementations actually want the longer strings. Maybe we can find a workaround by base64 encoding instead of stringifying the key and iv.</p><p>a quick test reveals, yes, we actually can:</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token console class-name">console</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">log</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">// &lt;Buffer c1 1e 98 84 54 eb 85 f6 b3 d0 51 87 d2 62 80 a7&gt;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span><span></span><span class="token token console class-name">console</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">log</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;base64&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#4e5c63">// wR6YhFTrhfaz0FGH0mKApw==</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span></span><span class="token token console class-name">console</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">log</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;base64&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;base64&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span></span><span class="token token" style="color:#4e5c63">//&lt;Buffer c1 1e 98 84 54 eb 85 f6 b3 d0 51 87 d2 62 80 a7&gt;</span></span></code></pre><p>now we could also just create a buffer again from the string to make it 16/32 bytes (ready for usage):</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&#x27;</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span></span><span class="token token" style="color:#4e5c63">//&lt;Buffer 50 35 ae 35 67 f2 e6 93 20 b0 83 d5 9a 73 64 cf 8d 4b 14 e7 7d 7b 79 80 51 24 1c e5 46 b3 27 d9&gt;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;1d6ef201e0e7a9019ddf8414034325e2&#x27;</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;hex&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span></span><span class="token token" style="color:#4e5c63">//&lt;Buffer 1d 6e f2 01 e0 e7 a9 01 9d df 84 14 03 43 25 e2&gt;</span></span></code></pre><p>This seems to be a nice solution when you <strong>receive</strong> the key and iv as an input; if we generate it ourselves, however, it better to just avoid the conversion to string after generation that many people use in examples:</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#4e5c63">// type Buffer, 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span></span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">// type Buffer, 32 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span></span><span class="token token" style="color:#1177ab">const</span><span> configKey </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">pbkdf2Sync</span><span class="token token" style="color:#999999">(</span><span>secretPhrase</span><span class="token token" style="color:#999999">,</span><span> salt</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">100000</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&#x27;sha256&#x27;</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span></code></pre><p>This key and IV pair can be consumed directly by our ciphers, but we would need to convert it to a hex string first to save and forward them.</p><h3>So what is the output of this function?</h3><p>The output we received is of type buffer, but when we convert it to a string using <code>toString(&#x27;hex&#x27;)</code> we can read the data:</p><ul><li><strong><code>OUTPUT</code></strong> = &#x27;&lt;Buffer f2 fb 62 b1 7e e9 da 0c 8c bd 56 f2 45 a9 87 60 b4 e2 a6 d0 c5 de f1 50 bc 6d 86 00 f8 5d b4 79&gt;&#x27; <code> //is 32 bytes</code></li><li><strong><code>OUTPUT_Stringified</code></strong> = &#x27;f2fb62b17ee9da0c8cbd56f245a98760b4e2a6d0c5def150bc6d8600f85db479&#x27; <code> //is now 64 bytes string</code></li><li><strong><code>OUTPUT_Base64</code></strong> = &#x27;8vtisX7p2gyMvVbyRamHYLTiptDF3vFQvG2GAPhdtHk=&#x27; <code> //is now 44 bytes string</code></li></ul><p>so using the codes below, we can switch between these three outputs as we like</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#4e5c63">//output Buffer</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span>encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>encrypted</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token maybe-class-name">Cipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">//output String</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span>encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>encrypted</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token maybe-class-name">Cipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;hex&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#4e5c63">//output Base64</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span>encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>encrypted</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token maybe-class-name">Cipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span></span><span class="token token" style="color:#4e5c63">//revert conversion to base64</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span></span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span>encrypted</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span></span></code></pre><p>From what we have learned here, I guess the best option is to use the base64 output method since we can easily convert it to a buffer</p><h2>Using browserify-aes&#x27;s node crypto-like implementation inside the Browser</h2><p>Inside the browser, we cannot use Nodes.js built-in modules. Using <code>browserify-aes</code> we can use a node-like crypto implementation, which uses the same syntax as the node implementation. In my use case, I only need to decipher in the browser, this means I don’t have to worry about a truly random key generation or ciphering.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token module" style="color:#1177ab">import</span><span> </span><span class="token token imports">crypto</span><span> </span><span class="token token module" style="color:#1177ab">from</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;browserify-aes&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span> *        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63"> ***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token function-variable" style="color:#c7526d">decrypt</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token parameter maybe-class-name">Base64Hash</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span>  </span><span class="token token" style="color:#4e5c63">//we use the base64 hash generated by openssl cli as an input</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token maybe-class-name">Base64Hash</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg=&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token maybe-class-name">Key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;1d6ef201e0e7a9019ddf8414034325e2&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token function-variable" style="color:#c7526d">hexToBin</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token parameter">hex</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>    </span><span class="token token" style="color:#4e5c63">//converts hex strings to binary arr</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>    </span><span class="token token control-flow" style="color:#1177ab">for</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#1177ab">var</span><span> bytes </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">[</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">,</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">;</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">&lt;</span><span> hex</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">length</span><span class="token token" style="color:#999999">;</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">+=</span><span> </span><span class="token token" style="color:#4499ee">2</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>      bytes</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">push</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c7526d">parseInt</span><span class="token token" style="color:#999999">(</span><span>hex</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span>c</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">2</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span><span>    </span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>    </span><span class="token token control-flow" style="color:#1177ab">return</span><span> bytes</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span><span>  </span><span class="token token" style="color:#999999">}</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span>  </span><span class="token token" style="color:#4e5c63">//ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> decipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createDecipheriv</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;aes256&quot;</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>    </span><span class="token token" style="color:#c7526d">hexToBin</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Key</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span><span>    </span><span class="token token" style="color:#c7526d">hexToBin</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>  </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span><span>  </span><span class="token token" style="color:#4e5c63">//der hash wird nun decrypted mittels dem zuvor erstellten cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> decrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span><span>    decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Base64Hash</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span><span>    decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">33</span><span>  </span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;utf8&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">34</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">35</span><span>  </span><span class="token token control-flow" style="color:#1177ab">return</span><span> </span><span class="token token known-class-name class-name">JSON</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">parse</span><span class="token token" style="color:#999999">(</span><span>decrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">36</span><span></span><span class="token token" style="color:#999999">}</span><span class="token token" style="color:#999999">;</span></span></code></pre><ul><li><strong><code>OUTPUT</code></strong> = {TestData: &quot;w17h Spé^cIäl chàær§¢tèrs&quot;, OK: &quot;://seems/fine?x=lol&quot;} <code> //yes, thats our original input! :D</code></li></ul><h2>ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL</h2><p>In PHP 7 we make use of the <code>openssl_encrypt</code> implementation to encrypt an utf8 string and finally encode it with <code>base64_encode</code>.
For decryption we also make use of the official openssl implementation <code>openssl_decrypt</code>, before decrypting we need to decode using <code>base64_decode</code>.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span>*        ENCRYPTION &amp; DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span>*
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span class="token token doc-comment" style="color:#4e5c63">***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#1177ab">class</span><span> </span><span class="token token class-name-definition class-name">AESEncryption</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span>   </span><span class="token token" style="color:#4e5c63">//key length should be 256 bits for aes 256 this means we use a string with 32 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>   </span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token double-quoted-string" style="color:#c9c0be;background:#000000">&quot;5f08e0ec585393a8e2ca8f0a1a0ae752&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>    </span><span class="token token" style="color:#4e5c63">//iv length should be always be 128 bit / 16 bytes</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>   </span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$iv</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token double-quoted-string" style="color:#c9c0be;background:#000000">&quot;05d387e7f773035a&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>    </span><span class="token token" style="color:#4e5c63">// The AES uses a block size of sixteen octets (128 bits)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>   </span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#ee9900">$Method</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;AES-256-CBC&#x27;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>   </span><span class="token token doc-comment" style="color:#4e5c63">/**
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span>     * use the AES to encrypt plaintext data and return a base 64 string
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span>    *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span>    * $key
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span class="token token doc-comment" style="color:#4e5c63">    */</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>   </span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#1177ab">function</span><span> </span><span class="token token function-definition" style="color:#c7526d">encrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$cleartext</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>       </span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#1177ab">empty</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">?</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#999999">:</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>       </span><span class="token token" style="color:#ee9900">$encrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">openssl_encrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$cleartext</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$Method</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">OPENSSL_RAW_DATA</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$iv</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span><span>       </span><span class="token token" style="color:#1177ab">return</span><span> </span><span class="token token" style="color:#c7526d">base64_encode</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span><span>   </span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">33</span><span>   </span><span class="token token doc-comment" style="color:#4e5c63">/**
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">34</span>     * use the AES to decrypt a base 64 string into plaintext
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">35</span>    *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">36</span>    * $key
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">37</span><span class="token token doc-comment" style="color:#4e5c63">    */</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">38</span><span>   </span><span class="token token" style="color:#1177ab">public</span><span> </span><span class="token token" style="color:#1177ab">static</span><span> </span><span class="token token" style="color:#1177ab">function</span><span> </span><span class="token token function-definition" style="color:#c7526d">decrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">,</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token single-quoted-string" style="color:#c9c0be;background:#000000">&#x27;&#x27;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">39</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">40</span><span>       </span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#1177ab">empty</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">?</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$key</span><span> </span><span class="token token" style="color:#999999">:</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">41</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">42</span><span>       </span><span class="token token" style="color:#ee9900">$encrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">base64_decode</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">43</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">44</span><span>       </span><span class="token token" style="color:#ee9900">$decrypted</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">openssl_decrypt</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$encrypted</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$Method</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#ee9900">$key</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">OPENSSL_RAW_DATA</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token scope" style="color:#1177ab">self</span><span class="token token scope" style="color:#999999">::</span><span class="token token" style="color:#ee9900">$iv</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">45</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">46</span><span>       </span><span class="token token" style="color:#1177ab">return</span><span> </span><span class="token token" style="color:#c7526d">trim</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#ee9900">$decrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">47</span><span>   </span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">48</span><span></span><span class="token token" style="color:#999999">}</span></span></code></pre><blockquote><p>while desperately searching for a solution I looked into doing the encryption in PHP instead of openssl, since I scrapped this idea I cannot explain any further. I still keep this PHP 7 example here because its hard to find examples online that don’t use mcrypt.</p></blockquote><h2>Using OpenSSL for use in CLI</h2><p>Inside of a Command Line Interface, we use <code>openssl</code> do en- or decrypt data.</p><p>For node/browserify to be able to decrypt it we need to add the <code>-nosalt</code> option, which disables salting the data.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token" style="color:#4e5c63">#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span></span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#4e5c63">#encrypt with key &amp; IV but no salt</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#c7526d">cat</span><span> config.json </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -A -nosalt -base64
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span></span><span class="token token" style="color:#4e5c63">#decrypt with key IV and base64</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span></span><span class="token token class-name" style="color:#f07693">echo</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;encryptedString&quot;</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -d -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -base64 -A</span></span></code></pre><h3>testing the implementation</h3><p>I created a json file called <code>test.json</code> containing the inputData. so when we run the following command ...</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#c7526d">cat</span><span> test.json </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -iv </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;1d6ef201e0e7a9019ddf8414034325e2&quot;</span><span>  -K </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&quot;</span><span> -A -nosalt</span></span></code></pre><p>We get no warnings and an output like this:</p><ul><li><strong><code>OUTPUT</code></strong> = g??.G?٪a?W????ԝFv?? 0P0+v?&#x27;???R=CR??a? ?5!??N?&quot;?e?q?M{C??:u-?wH?? <code> //weird looking binary data</code></li></ul><p>as you can see this is not very usefull so we apply the base64 encoding after encryption</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#c7526d">cat</span><span> test.json </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -iv </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;1d6ef201e0e7a9019ddf8414034325e2&quot;</span><span>  -K </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&quot;</span><span> -A -nosalt -base64</span></span></code></pre><ul><li><strong><code>OUTPUT_base64</code></strong> = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg= <code> //now this looks nice</code></li></ul><p>now we can also decrypt the just created data like so</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token class-name" style="color:#f07693">echo</span><span> </span><span class="token token" style="color:#ee9900">$encryptedData</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -d -iv </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;1d6ef201e0e7a9019ddf8414034325e2&quot;</span><span> -K </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&quot;</span><span> -A -base64</span></span></code></pre><p>This yields us this output</p><ul><li><strong><code>OUTPUT</code></strong> = {&quot;TestData&quot;:&quot;w17h Spé^cIäl chàær§¢tèrs&quot;, &quot;OK&quot;:&quot;://seems/fine?x=lol&quot;} <code> //yes, thats our original input! :)</code></li></ul><h1>final solution</h1><h2>Using NodeJS during initial build</h2><p>While building our app this code is responsible for:</p><ul><li>creating a unique <code>key</code> on every build</li><li>creating a unique <code>iv</code> for every object to be encrypted</li><li>outputting an encrypted base64 encoded string of data</li></ul><p>the output needs to be consumed by either:</p><ul><li>the application during runtime (browserify implementation)</li><li>openssl in case of deployment</li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#1177ab">const</span><span> crypto </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#c7526d">require</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;crypto&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span> *        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63"> ***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span></span><span class="token token" style="color:#1177ab">const</span><span> encryption </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>  data </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">{</span><span> </span><span class="token token maybe-class-name">TestData</span><span class="token token" style="color:#c9c0be;background:#000000">:</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;w17h Spé^cIäl chàær§¢tèrs&quot;</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">OK</span><span class="token token" style="color:#c9c0be;background:#000000">:</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;://seems/fine?x=lol&quot;</span><span> </span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span></span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> secretPhrase </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;hex&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> salt </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">128</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">/</span><span> </span><span class="token token" style="color:#4499ee">8</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;hex&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>  </span><span class="token token" style="color:#4e5c63">//here we generate the key and give it back as a string, we use 100k iterations</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>  </span><span class="token token" style="color:#4e5c63">//as suggested in best practices</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>  </span><span class="token token" style="color:#4e5c63">//We can use the key multiple times to encrypt multiple things(-30GB), we just cant use</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>  </span><span class="token token" style="color:#4e5c63">//the same initialization vector twice</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>  </span><span class="token token" style="color:#4e5c63">//the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters it is currently of type Buffer</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> configKey </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">pbkdf2Sync</span><span class="token token" style="color:#999999">(</span><span>secretPhrase</span><span class="token token" style="color:#999999">,</span><span> salt</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">100000</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">32</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;sha256&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>  </span><span class="token token" style="color:#4e5c63">//create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes. it is currently of type buffer</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">randomBytes</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>  </span><span class="token token" style="color:#4e5c63">//create ciphers for each encryption using the shared key and the unuique IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> projectConfigCipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createCipheriv</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;aes-256-cbc&quot;</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span><span>    configKey</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>    </span><span class="token token" style="color:#4499ee">IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span><span>  </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span><span>  </span><span class="token token" style="color:#4e5c63">//when using hex strings as IV/keys you can convert it into a buffer to make it work:</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span><span>  </span><span class="token token" style="color:#4e5c63">//Buffer.from(&#x27;1d6ef201e0e7a9019ddf8414034325e2&#x27;,&#x27;hex&#x27;)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span><span>  </span><span class="token token" style="color:#4e5c63">//encrypting the storage location using the prepared cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">33</span><span>  </span><span class="token token" style="color:#4e5c63">// our input is an object, so we first stringify it and set the input encoding to utf8, for our output we need base64 encoding</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">34</span><span>  </span><span class="token token" style="color:#1177ab">let</span><span> encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> projectConfigCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">35</span><span>    </span><span class="token token known-class-name class-name">JSON</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">stringify</span><span class="token token" style="color:#999999">(</span><span>data</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">36</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;utf8&quot;</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">37</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">38</span><span>  </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">39</span><span>  </span><span class="token token" style="color:#4e5c63">// finalize the encryption also with base64 output encoding</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">40</span><span>  encrypted </span><span class="token token" style="color:#c9c0be;background:#000000">+=</span><span> projectConfigCipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">41</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">42</span><span>  </span><span class="token token doc-comment" style="color:#4e5c63">/***************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">43</span>   * To be able to decrypt later, we need to save the IV and key somewhere.
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">44</span>   * it is recommended to store the iv together with the encrypted
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">45</span>   * data, but you should store the key separately. we save those values
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">46</span>   *  as hex-encoded strings - so the can later be converted into binary again
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">47</span><span class="token token doc-comment" style="color:#4e5c63">   ****************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">48</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> saveKey </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> key</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;hex&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">49</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> saveIV </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;hex&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">50</span><span>  </span><span class="token token" style="color:#4e5c63">// the above strings can be directly interpreted by openssl</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">51</span><span>  </span><span class="token token" style="color:#4e5c63">// the above key can be converted to a buffer in node: Buffer.from(saveKey, &#x27;hex&#x27;)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">52</span><span>  </span><span class="token token" style="color:#4e5c63">// the above key can be converted to binary using hexToBin() in the browser</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">53</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">54</span><span>  </span><span class="token token control-flow" style="color:#1177ab">return</span><span> encrypted</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">55</span><span></span><span class="token token" style="color:#999999">}</span><span class="token token" style="color:#999999">;</span></span></code></pre><ul><li><strong><code>OUTPUT_DATA</code></strong> = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUSgCV12rE4RpgPdjXMJJB2vNJZ+00LvE9nkn77fW0pf8c/tzW5MxQpzqV3A+HvniM= <code> //look what a nice base64 string</code></li><li><strong><code>OUTPUT_KEY</code></strong> = &#x27;5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9&#x27;</li><li><strong><code>OUTPUT_IV</code></strong> = &#x27;1d6ef201e0e7a9019ddf8414034325e2&#x27;</li></ul><p>Our output data looks good, so lets test what openssl can do with it!</p><h2>Using Node.crypto&#x27;s output as input in openssl</h2><p>from node, we get the data shown above as files named <em>key</em> and <em>iv</em>
In my use case we only need the <code>key</code> and <code>IV</code> to encrypt a new config. I still did include a decryption example as well here.</p><p>Things to keep in mind:</p><ul><li>output encoding must be base64</li><li><code>-nosalt</code> option needs to be enabled</li><li><code>-A</code> option needs to be enabled</li></ul><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token" style="color:#4e5c63">#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span><span></span><span class="token token" style="color:#4e5c63">#                                                                                       #</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span><span></span><span class="token token" style="color:#4e5c63">#########################################################################################</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span></span><span class="token token" style="color:#4e5c63">#encrypt with key &amp; IV but no salt</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#4e5c63">#config.json contains the testdata defined above</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span></span><span class="token token" style="color:#c7526d">cat</span><span> config.json </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -A -nosalt -base64
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span><span></span><span class="token token" style="color:#4e5c63">#decrypt with key IV and base64</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span></span><span class="token token" style="color:#4e5c63"># we use the output base64 string from node here</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span></span><span class="token token class-name" style="color:#f07693">echo</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUSgCV12rE4RpgPdjXMJJB2vNJZ+00LvE9nkn77fW0pf8c/tzW5MxQpzqV3A+HvniM=&quot;</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">|</span><span> openssl aes-256-cbc -d -iv </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> iv</span><span class="token token" style="color:#ee9900">)</span><span>  -K </span><span class="token token" style="color:#ee9900">$(</span><span class="token token" style="color:#c7526d">cat</span><span class="token token" style="color:#ee9900"> key</span><span class="token token" style="color:#ee9900">)</span><span> -base64 -A</span></span></code></pre><h3>Encryption output:</h3><ul><li><strong><code>OUTPUT_encrypt</code></strong> = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg= <code>//looking good..</code></li></ul><h3>Decryption output:</h3><ul><li><strong><code>OUTPUT_decrypt</code></strong> = {&quot;TestData&quot;:&quot;w17h Spé^cIäl chàær§¢tèrs&quot;,&quot;OK&quot;:&quot;://seems/fine?x=lol&quot;} <code> //nice, thats our original data!</code></li></ul><p>Since our Output looks good and even the decryption worked fine, lets test what our browserify implementation can do with this.</p><h2>Using browserify to decrypt node or openssl input</h2><p>This code expects the following input:</p><ul><li>base64 encoded string to decrypt</li><li>iv in the form of a hex-encoded string</li><li>key in the form of a hex-encoded string</li></ul><p>I get the keys from process.env in this example. You could also receive them via input or even a file.</p><p>This code needs to be able to produce consistent output when receiving input from either node or openssl.</p><p>We had to create a custom function <code>hexToBin()</code> to convert a hex string into a binary array to be consumed by our cipher.</p><pre style="padding:1em;margin:.5em 0;overflow:auto;border-radius:12px;background:#121212;box-shadow:9px 9px 13px rgba(48,48,48, 0.5), -9px -9px 12px rgb(4,4,4,0.6)"><code style="background-color:transparent;color:#C9C0BE;width:1024px;white-space:pre"><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">1</span><span class="token token module" style="color:#1177ab">import</span><span> </span><span class="token token imports">crypto</span><span> </span><span class="token token module" style="color:#1177ab">from</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;browserify-aes&quot;</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">2</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">3</span><span></span><span class="token token doc-comment" style="color:#4e5c63">/**********************************************************************
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">4</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">5</span> *        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">6</span> *
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">7</span><span class="token token doc-comment" style="color:#4e5c63"> ***********************************************************************/</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">8</span><span></span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token function-variable" style="color:#c7526d">decrypt</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token parameter maybe-class-name">Base64Hash</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">9</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token maybe-class-name">Key</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> process</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">env</span><span class="token token" style="color:#999999">.</span><span class="token token" style="color:#4499ee">APP_KEY</span><span class="token token" style="color:#999999">;</span><span> </span><span class="token token" style="color:#4e5c63">//hex encoded string</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">10</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token" style="color:#4499ee">IV</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> process</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">env</span><span class="token token" style="color:#999999">.</span><span class="token token" style="color:#4499ee">APP_IV</span><span class="token token" style="color:#999999">;</span><span> </span><span class="token token" style="color:#4e5c63">//hex encoded string</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">11</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">12</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> </span><span class="token token function-variable" style="color:#c7526d">hexToBin</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token parameter">hex</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token arrow" style="color:#c9c0be;background:#000000">=&gt;</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">13</span><span>    </span><span class="token token" style="color:#4e5c63">//converts hex strings to binary arr</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">14</span><span>    </span><span class="token token control-flow" style="color:#1177ab">for</span><span> </span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#1177ab">var</span><span> bytes </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#999999">[</span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">,</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token" style="color:#4499ee">0</span><span class="token token" style="color:#999999">;</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">&lt;</span><span> hex</span><span class="token token" style="color:#999999">.</span><span class="token token property-access">length</span><span class="token token" style="color:#999999">;</span><span> c </span><span class="token token" style="color:#c9c0be;background:#000000">+=</span><span> </span><span class="token token" style="color:#4499ee">2</span><span class="token token" style="color:#999999">)</span><span> </span><span class="token token" style="color:#999999">{</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">15</span><span>      bytes</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">push</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c7526d">parseInt</span><span class="token token" style="color:#999999">(</span><span>hex</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">substr</span><span class="token token" style="color:#999999">(</span><span>c</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">2</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#4499ee">16</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">16</span><span>    </span><span class="token token" style="color:#999999">}</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">17</span><span>    </span><span class="token token control-flow" style="color:#1177ab">return</span><span> bytes</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">18</span><span>  </span><span class="token token" style="color:#999999">}</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">19</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">20</span><span>  </span><span class="token token" style="color:#4e5c63">//ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">21</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> decipher </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> crypto</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">createDecipheriv</span><span class="token token" style="color:#999999">(</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">22</span><span>    </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;aes256&quot;</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">23</span><span>    </span><span class="token token" style="color:#c7526d">hexToBin</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Key</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">24</span><span>    </span><span class="token token" style="color:#c7526d">hexToBin</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#4499ee">IV</span><span class="token token" style="color:#999999">)</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">25</span><span>  </span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">26</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">27</span><span>  </span><span class="token token" style="color:#4e5c63">//der hash wird nun decrypted mittels dem zuvor erstellten cipher</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">28</span><span>  </span><span class="token token" style="color:#1177ab">const</span><span> decrypted </span><span class="token token" style="color:#c9c0be;background:#000000">=</span><span> </span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">concat</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">[</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">29</span><span>    decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">update</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Buffer</span><span class="token token" style="color:#999999">.</span><span class="token token module" style="color:#1177ab">from</span><span class="token token" style="color:#999999">(</span><span class="token token maybe-class-name">Base64Hash</span><span class="token token" style="color:#999999">,</span><span> </span><span class="token token" style="color:#c9c0be;background:#000000">&quot;base64&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">30</span><span>    decipher</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">final</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">,</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">31</span><span>  </span><span class="token token" style="color:#999999">]</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">toString</span><span class="token token" style="color:#999999">(</span><span class="token token" style="color:#c9c0be;background:#000000">&quot;utf8&quot;</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">32</span>
</span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">33</span><span>  </span><span class="token token control-flow" style="color:#1177ab">return</span><span> </span><span class="token token known-class-name class-name">JSON</span><span class="token token" style="color:#999999">.</span><span class="token token method property-access" style="color:#c7526d">parse</span><span class="token token" style="color:#999999">(</span><span>decrypted</span><span class="token token" style="color:#999999">)</span><span class="token token" style="color:#999999">;</span><span>
</span></span><span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#4e5c63">34</span><span></span><span class="token token" style="color:#999999">}</span><span class="token token" style="color:#999999">;</span></span></code></pre><ul><li><strong><code>OUTPUT_openssl</code></strong> = {TestData: &quot;w17h Spé^cIäl chàær§¢tèrs&quot;, OK: &quot;://seems/fine?x=lol&quot;} <code> //yes, thats our original input! :D</code></li><li><strong><code>OUTPUT_nodejs</code></strong> = {TestData: &quot;w17h Spé^cIäl chàær§¢tèrs&quot;, OK: &quot;://seems/fine?x=lol&quot;} <code> //and we even handled the node version! sick!</code></li></ul><p>That&#x27;s it! We did it yay!</p><blockquote><p>Feel free to comment and discuss on my gist: <a href="https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a">This project on gist</a></p></blockquote></div></div></div></div></div><style data-emotion="css 1rr4qq7">.css-1rr4qq7{-webkit-flex:1;-ms-flex:1;flex:1;}</style><div class="MuiBox-root css-1rr4qq7"></div><div style="top:0;width:90%;border-radius:12px;margin-bottom:12px;height:56px;display:flex;flex-direction:row;align-items:center;justify-content:space-between;background-color:#04060A;color:#F07693;padding:24px;font-size:12pt;background:#141414;box-shadow:9px 9px 12px rgb(4,4,4,0.6), -9px -9px 12px  rgba(48,48,48, 0.5)"><p>© lwlx. 2022</p><a href="https://twitter.com/0x0000005"><svg height="24" viewBox="0 0 24 24"><g><path fill="#fff" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g></svg></a><a href="https://github.com/Lawlez"><svg height="24" viewBox="0 0 16 16" version="1.1" width="24" aria-hidden="true"><path fill="#fff" fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a><p>Version <!-- -->0.7.3</p></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"path":"blog/consistent-x-device-encryption-in-javascript","title":"Getting consistent Encryption in Node / PHP / Browser and openSSL","subtitle":null,"published":true,"datePublished":1603967203286,"tags":["encryption","decryption","openssl","nodejs","php"],"description":"Cryptography is hard, and because it's already hard enough, here is a nice guide on the AES Cipher in different environments.","canonicalUrl":"https://dev.lwlx.xyz/blog/consistent-x-device-encryption-in-javascript","author":"lwlx","authorPhoto":"/profile","authorTwitter":"0x0000005","bannerPhoto":"/crypto","thumbnailPhoto":"/crypto_thumb.jpg","content":"\nI recently was tasked to find a solution for encrypting data in different places and to being able to decrypt them all in a browser during runtime.\n\nSurprisingly, it was much more challenging than expected since there was so little documentation around this online. What was available were a few code-only examples, so I was forced to do R \u0026 D and try all implementations and compare the in- \u0026 outputs.\n\nGiven the lack of a decent out-of-the-box solution, I worry that many developers are settling for easy to use, insecure solutions that limit your project’s security and flexibility. Security should be easy to use and accessible.\n\n\u003e Clone the repo here to get started with this setup: \u003ca href=\"https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a\"\u003ehttps://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a\u003c/a\u003e\n\nOkay, so lets assume we use following input data to test each implementation:\n\n- **`key`** = '5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9' ` //must be 256 bits`\n- **`iv`** = '1d6ef201e0e7a9019ddf8414034325e2' ` //must be 128 bits`\n- **`inputData`** = `{\"TestData\":\"w17h Spé^cIäl chàær§¢tèrs\", \"OK\":\"://seems/fine?x=lol\"}`\n\nLet's quickly run through and test each implementation:\n\n## Using Node JS Crypto module\n\nNode Provides a nice `crypto` implementation. It's documentation is rather sparse, but this is what most resources suggest by using:\n\n- `crypto.randomBytes()`\n- `crypto.createCipheriv()`\n- `crypto.createDecipheriv()`\n\n```javascript\nconst crypto = require('crypto')\n\n/**********************************************************************\n*\n*        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *\n*\n***********************************************************************/\n\nconst encryption = (data = 'TestString {} Héllöüä') =\u003e {\n\n   const secretPhrase = crypto.randomBytes(16).toString('hex')\n   const salt = crypto.randomBytes(128 / 8).toString('hex')\n   //here we generate the key and give it back as a string, we use 100k iterations\n   //as suggested in best practices\n   //We can use the key multiple times to encrypt multiple things(-30GB), we just cant use\n   //the same initialization vector twice\n   //the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters\n   const configKey = crypto.pbkdf2Sync(secretPhrase, salt, 100000, 32, 'sha256').toString('hex').substr(0, 32)\n   //create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes\n   const IV = crypto.randomBytes(16)\n\n   //create ciphers for each encryption using the shared key and the unuique IV\n   const projectConfigCipher = crypto.createCipheriv('aes-256-cbc', configKey, IV.toString('hex').substr(0,16)\n\n   //encripting the storage location using the prepared cipher\n   const encrypted = Buffer.concat([configStorageCipher.update(\n       'STORAGE', 'utf8'\n   ), configStorageCipher.final()]).toString('hex')\n\n   return encrypted\n\n}\n```\n\n\u003e this is **NOT** the final implementation; check below to see it.\n\n### Testing the implementation\n\nWe notice that we need to trim the key to 32bytes and the IV to 16 bytes. This is likely because of the conversion from hex to string after the creation of the key.\n\n- **`key`** = '5035ae3567f2e69320b083d59a7364cf' ` //is now 32 bytes string`\n- **`iv`** = '1d6ef201e0e7a901' ` //is now 16 bytes string`\n\nThis will probably lead to an issue later on since other implementations actually want the longer strings. Maybe we can find a workaround by base64 encoding instead of stringifying the key and iv.\n\na quick test reveals, yes, we actually can:\n\n```\nconst IV = crypto.randomBytes(16)\n\nconsole.log(IV)\n// \u003cBuffer c1 1e 98 84 54 eb 85 f6 b3 d0 51 87 d2 62 80 a7\u003e\n\nconsole.log(IV.toString('base64'))\n// wR6YhFTrhfaz0FGH0mKApw==\n\nconsole.log(Buffer.from(IV.toString('base64'), 'base64'))\n//\u003cBuffer c1 1e 98 84 54 eb 85 f6 b3 d0 51 87 d2 62 80 a7\u003e\n```\n\nnow we could also just create a buffer again from the string to make it 16/32 bytes (ready for usage):\n\n```\nBuffer.from('5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9', 'hex')\n//\u003cBuffer 50 35 ae 35 67 f2 e6 93 20 b0 83 d5 9a 73 64 cf 8d 4b 14 e7 7d 7b 79 80 51 24 1c e5 46 b3 27 d9\u003e\n\nBuffer.from('1d6ef201e0e7a9019ddf8414034325e2','hex'))\n//\u003cBuffer 1d 6e f2 01 e0 e7 a9 01 9d df 84 14 03 43 25 e2\u003e\n```\n\nThis seems to be a nice solution when you **receive** the key and iv as an input; if we generate it ourselves, however, it better to just avoid the conversion to string after generation that many people use in examples:\n\n```\n// type Buffer, 16 bytes\nconst IV = crypto.randomBytes(16)\n\n// type Buffer, 32 bytes\nconst configKey = crypto.pbkdf2Sync(secretPhrase, salt, 100000, 32, 'sha256')\n\n```\n\nThis key and IV pair can be consumed directly by our ciphers, but we would need to convert it to a hex string first to save and forward them.\n\n### So what is the output of this function?\n\nThe output we received is of type buffer, but when we convert it to a string using `toString('hex')` we can read the data:\n\n- **`OUTPUT`** = '\u003cBuffer f2 fb 62 b1 7e e9 da 0c 8c bd 56 f2 45 a9 87 60 b4 e2 a6 d0 c5 de f1 50 bc 6d 86 00 f8 5d b4 79\u003e' ` //is 32 bytes`\n- **`OUTPUT_Stringified`** = 'f2fb62b17ee9da0c8cbd56f245a98760b4e2a6d0c5def150bc6d8600f85db479' ` //is now 64 bytes string`\n- **`OUTPUT_Base64`** = '8vtisX7p2gyMvVbyRamHYLTiptDF3vFQvG2GAPhdtHk=' ` //is now 44 bytes string`\n\nso using the codes below, we can switch between these three outputs as we like\n\n```javascript\n//output Buffer\nencrypted = Buffer.concat([encrypted, Cipher.final()]);\n\n//output String\nencrypted = Buffer.concat([encrypted, Cipher.final()]).toString(\"hex\");\n\n//output Base64\nencrypted = Buffer.concat([encrypted, Cipher.final()]).toString(\"base64\");\n\n//revert conversion to base64\nBuffer.from(encrypted.toString(\"base64\"), \"base64\");\n```\n\nFrom what we have learned here, I guess the best option is to use the base64 output method since we can easily convert it to a buffer\n\n## Using browserify-aes's node crypto-like implementation inside the Browser\n\nInside the browser, we cannot use Nodes.js built-in modules. Using `browserify-aes` we can use a node-like crypto implementation, which uses the same syntax as the node implementation. In my use case, I only need to decipher in the browser, this means I don’t have to worry about a truly random key generation or ciphering.\n\n```js\nimport crypto from \"browserify-aes\";\n\n/**********************************************************************\n *\n *        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *\n *\n ***********************************************************************/\nconst decrypt = (Base64Hash) =\u003e {\n  //we use the base64 hash generated by openssl cli as an input\n  const Base64Hash =\n    \"Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg=\";\n  const Key =\n    \"5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9\";\n  const IV = \"1d6ef201e0e7a9019ddf8414034325e2\";\n  const hexToBin = (hex) =\u003e {\n    //converts hex strings to binary arr\n    for (var bytes = [], c = 0; c \u003c hex.length; c += 2) {\n      bytes.push(parseInt(hex.substr(c, 2), 16));\n    }\n    return bytes;\n  };\n  //ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV\n  const decipher = crypto.createDecipheriv(\n    \"aes256\",\n    hexToBin(Key),\n    hexToBin(IV)\n  );\n\n  //der hash wird nun decrypted mittels dem zuvor erstellten cipher\n  const decrypted = Buffer.concat([\n    decipher.update(Buffer.from(Base64Hash, \"base64\")),\n    decipher.final(),\n  ]).toString(\"utf8\");\n\n  return JSON.parse(decrypted);\n};\n```\n\n- **`OUTPUT`** = {TestData: \"w17h Spé^cIäl chàær§¢tèrs\", OK: \"://seems/fine?x=lol\"} ` //yes, thats our original input! :D`\n\n## ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL\n\nIn PHP 7 we make use of the `openssl_encrypt` implementation to encrypt an utf8 string and finally encode it with `base64_encode`.\nFor decryption we also make use of the official openssl implementation `openssl_decrypt`, before decrypting we need to decode using `base64_decode`.\n\n```php\n/**********************************************************************\n*\n*        ENCRYPTION \u0026 DECRYPTION MODULE FOR PHP7+ USING OPENSSL       *\n*\n***********************************************************************/\n\nclass AESEncryption {\n\n   //key length should be 256 bits for aes 256 this means we use a string with 32 bytes\n   public static $key = \"5f08e0ec585393a8e2ca8f0a1a0ae752\";\n\n    //iv length should be always be 128 bit / 16 bytes\n   public static $iv = \"05d387e7f773035a\";\n\n    // The AES uses a block size of sixteen octets (128 bits)\n   public static $Method = 'AES-256-CBC';\n\n   /**\n     * use the AES to encrypt plaintext data and return a base 64 string\n    *\n    * $key\n    */\n   public static function encrypt($cleartext,$key = ''){\n\n       $key = empty($key) ? self::$key : $key;\n\n       $encrypted = openssl_encrypt($cleartext, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n       return base64_encode($encrypted);\n\n   }\n\n   /**\n     * use the AES to decrypt a base 64 string into plaintext\n    *\n    * $key\n    */\n   public static function decrypt($encrypted,$key = ''){\n\n       $key = empty($key) ? self::$key : $key;\n\n       $encrypted = base64_decode($encrypted);\n\n       $decrypted = openssl_decrypt($encrypted, self::$Method, $key, OPENSSL_RAW_DATA, self::$iv);\n\n       return trim($decrypted);\n   }\n}\n```\n\n\u003e while desperately searching for a solution I looked into doing the encryption in PHP instead of openssl, since I scrapped this idea I cannot explain any further. I still keep this PHP 7 example here because its hard to find examples online that don’t use mcrypt.\n\n## Using OpenSSL for use in CLI\n\nInside of a Command Line Interface, we use `openssl` do en- or decrypt data.\n\nFor node/browserify to be able to decrypt it we need to add the `-nosalt` option, which disables salting the data.\n\n```bash\n#########################################################################################\n#                                                                                       #\n#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #\n#                                                                                       #\n#########################################################################################\n\n#encrypt with key \u0026 IV but no salt\ncat config.json | openssl aes-256-cbc -iv $(cat iv)  -K $(cat key) -A -nosalt -base64\n\n#decrypt with key IV and base64\necho \"encryptedString\" | openssl aes-256-cbc -d -iv $(cat iv)  -K $(cat key) -base64 -A\n```\n\n### testing the implementation\n\nI created a json file called `test.json` containing the inputData. so when we run the following command ...\n\n```bash\ncat test.json | openssl aes-256-cbc -iv \"1d6ef201e0e7a9019ddf8414034325e2\"  -K \"5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9\" -A -nosalt\n```\n\nWe get no warnings and an output like this:\n\n- **`OUTPUT`** = g??.G?٪a?W????ԝFv?? 0P0+v?'???R=CR??a? ?5!??N?\"?e?q?M{C\\??:u-?wH?? ` //weird looking binary data`\n\nas you can see this is not very usefull so we apply the base64 encoding after encryption\n\n```bash\ncat test.json | openssl aes-256-cbc -iv \"1d6ef201e0e7a9019ddf8414034325e2\"  -K \"5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9\" -A -nosalt -base64\n```\n\n- **`OUTPUT_base64`** = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg= ` //now this looks nice`\n\nnow we can also decrypt the just created data like so\n\n```bash\necho $encryptedData | openssl aes-256-cbc -d -iv \"1d6ef201e0e7a9019ddf8414034325e2\" -K \"5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9\" -A -base64\n```\n\nThis yields us this output\n\n- **`OUTPUT`** = {\"TestData\":\"w17h Spé^cIäl chàær§¢tèrs\", \"OK\":\"://seems/fine?x=lol\"} ` //yes, thats our original input! :)`\n\n# final solution\n\n## Using NodeJS during initial build\n\nWhile building our app this code is responsible for:\n\n- creating a unique `key` on every build\n- creating a unique `iv` for every object to be encrypted\n- outputting an encrypted base64 encoded string of data\n\nthe output needs to be consumed by either:\n\n- the application during runtime (browserify implementation)\n- openssl in case of deployment\n\n```javascript\nconst crypto = require(\"crypto\");\n\n/**********************************************************************\n *\n *        DECRYPTION MODULE FOR USE INSIDE NODE.JS                     *\n *\n ***********************************************************************/\n\nconst encryption = (\n  data = { TestData: \"w17h Spé^cIäl chàær§¢tèrs\", OK: \"://seems/fine?x=lol\" }\n) =\u003e {\n  const secretPhrase = crypto.randomBytes(16).toString(\"hex\");\n  const salt = crypto.randomBytes(128 / 8).toString(\"hex\");\n  //here we generate the key and give it back as a string, we use 100k iterations\n  //as suggested in best practices\n  //We can use the key multiple times to encrypt multiple things(-30GB), we just cant use\n  //the same initialization vector twice\n  //the key for aes-256 needs to be 256 bits which equals 32 bytes or 32 characters it is currently of type Buffer\n  const configKey = crypto.pbkdf2Sync(secretPhrase, salt, 100000, 32, \"sha256\");\n  //create unique IV for each encryption, the key can be reused. IV needs to always be 16 bytes. it is currently of type buffer\n  const IV = crypto.randomBytes(16);\n\n  //create ciphers for each encryption using the shared key and the unuique IV\n  const projectConfigCipher = crypto.createCipheriv(\n    \"aes-256-cbc\",\n    configKey,\n    IV\n  );\n  //when using hex strings as IV/keys you can convert it into a buffer to make it work:\n  //Buffer.from('1d6ef201e0e7a9019ddf8414034325e2','hex')\n\n  //encrypting the storage location using the prepared cipher\n  // our input is an object, so we first stringify it and set the input encoding to utf8, for our output we need base64 encoding\n  let encrypted = projectConfigCipher.update(\n    JSON.stringify(data),\n    \"utf8\",\n    \"base64\"\n  );\n  // finalize the encryption also with base64 output encoding\n  encrypted += projectConfigCipher.final(\"base64\");\n\n  /***************************************************************\n   * To be able to decrypt later, we need to save the IV and key somewhere.\n   * it is recommended to store the iv together with the encrypted\n   * data, but you should store the key separately. we save those values\n   *  as hex-encoded strings - so the can later be converted into binary again\n   ****************************************************************/\n  const saveKey = key.toString(\"hex\");\n  const saveIV = IV.toString(\"hex\");\n  // the above strings can be directly interpreted by openssl\n  // the above key can be converted to a buffer in node: Buffer.from(saveKey, 'hex')\n  // the above key can be converted to binary using hexToBin() in the browser\n\n  return encrypted;\n};\n```\n\n- **`OUTPUT_DATA`** = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUSgCV12rE4RpgPdjXMJJB2vNJZ+00LvE9nkn77fW0pf8c/tzW5MxQpzqV3A+HvniM= ` //look what a nice base64 string`\n- **`OUTPUT_KEY`** = '5035ae3567f2e69320b083d59a7364cf8d4b14e77d7b798051241ce546b327d9'\n- **`OUTPUT_IV`** = '1d6ef201e0e7a9019ddf8414034325e2'\n\nOur output data looks good, so lets test what openssl can do with it!\n\n## Using Node.crypto's output as input in openssl\n\nfrom node, we get the data shown above as files named _key_ and _iv_\nIn my use case we only need the `key` and `IV` to encrypt a new config. I still did include a decryption example as well here.\n\nThings to keep in mind:\n\n- output encoding must be base64\n- `-nosalt` option needs to be enabled\n- `-A` option needs to be enabled\n\n```bash\n#########################################################################################\n#                                                                                       #\n#               ENCRYPTION FOR CLI IN / MACOS / LINUX / WINDOWS                         #\n#                                                                                       #\n#########################################################################################\n\n#encrypt with key \u0026 IV but no salt\n#config.json contains the testdata defined above\ncat config.json | openssl aes-256-cbc -iv $(cat iv)  -K $(cat key) -A -nosalt -base64\n\n#decrypt with key IV and base64\n# we use the output base64 string from node here\necho \"Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUSgCV12rE4RpgPdjXMJJB2vNJZ+00LvE9nkn77fW0pf8c/tzW5MxQpzqV3A+HvniM=\" | openssl aes-256-cbc -d -iv $(cat iv)  -K $(cat key) -base64 -A\n```\n\n### Encryption output:\n\n- **`OUTPUT_encrypt`** = Z8QIo6YuR7DZqmHHV4WqqorUnUZ2n88gMFADMCt2FKUn/ZeYUj1DEBNS2NthignUNR0hw+OOFU7qACKPZbxx8k0Pe0McXNDrOnUtl3dIwdg= `//looking good..`\n\n### Decryption output:\n\n- **`OUTPUT_decrypt`** = {\"TestData\":\"w17h Spé^cIäl chàær§¢tèrs\",\"OK\":\"://seems/fine?x=lol\"} ` //nice, thats our original data!`\n\nSince our Output looks good and even the decryption worked fine, lets test what our browserify implementation can do with this.\n\n## Using browserify to decrypt node or openssl input\n\nThis code expects the following input:\n\n- base64 encoded string to decrypt\n- iv in the form of a hex-encoded string\n- key in the form of a hex-encoded string\n\nI get the keys from process.env in this example. You could also receive them via input or even a file.\n\nThis code needs to be able to produce consistent output when receiving input from either node or openssl.\n\nWe had to create a custom function `hexToBin()` to convert a hex string into a binary array to be consumed by our cipher.\n\n```js\nimport crypto from \"browserify-aes\";\n\n/**********************************************************************\n *\n *        DECRYPTION MODULE FOR USE IN BROWSER DURING RUNTIME          *\n *\n ***********************************************************************/\nconst decrypt = (Base64Hash) =\u003e {\n  const Key = process.env.APP_KEY; //hex encoded string\n  const IV = process.env.APP_IV; //hex encoded string\n\n  const hexToBin = (hex) =\u003e {\n    //converts hex strings to binary arr\n    for (var bytes = [], c = 0; c \u003c hex.length; c += 2) {\n      bytes.push(parseInt(hex.substr(c, 2), 16));\n    }\n    return bytes;\n  };\n\n  //ein neuer cipher wird vorbereitet, mittels aes256, unserem 256 bit KEY und dem config IV\n  const decipher = crypto.createDecipheriv(\n    \"aes256\",\n    hexToBin(Key),\n    hexToBin(IV)\n  );\n\n  //der hash wird nun decrypted mittels dem zuvor erstellten cipher\n  const decrypted = Buffer.concat([\n    decipher.update(Buffer.from(Base64Hash, \"base64\")),\n    decipher.final(),\n  ]).toString(\"utf8\");\n\n  return JSON.parse(decrypted);\n};\n```\n\n- **`OUTPUT_openssl`** = {TestData: \"w17h Spé^cIäl chàær§¢tèrs\", OK: \"://seems/fine?x=lol\"} ` //yes, thats our original input! :D`\n- **`OUTPUT_nodejs`** = {TestData: \"w17h Spé^cIäl chàær§¢tèrs\", OK: \"://seems/fine?x=lol\"} ` //and we even handled the node version! sick!`\n\nThat's it! We did it yay!\n\n\u003e Feel free to comment and discuss on my gist: \u003ca href=\"https://gist.github.com/Lawlez/88e04e3541cc0608c953a118b86bfc1a\"\u003eThis project on gist\u003c/a\u003e\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"consistent-x-device-encryption-in-javascript"},"buildId":"sei3j9AmjPPP3iDNhxl-y","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>